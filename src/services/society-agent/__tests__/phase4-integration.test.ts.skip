// kilocode_change - new file
/**
 * Phase 4 Integration Test
 * 
 * Tests supervisor communication, agent messaging, and task delegation.
 */

import { SupervisorChannel, MockSupervisorChannel } from "../supervisor-channel"
import { ApprovalManager } from "../approval"
import type { ApprovalRequest } from "../approval"

/**
 * Test supervisor channel
 */
async function testSupervisorChannel() {
	console.log("\n=== Testing Supervisor Channel ===")

	const channel = new MockSupervisorChannel("test-agent-1", true)

	// Test connection
	await channel.connect()
	console.log("✓ Connected to supervisor")

	// Test approval request
	const request: ApprovalRequest = {
		id: "test-request-1",
		agentId: "test-agent-1",
		tool: "execute_command",
		parameters: { command: "rm -rf /" },
		context: { reason: "Testing approval workflow" },
		timestamp: Date.now(),
	}

	const response = await channel.requestApproval(request)
	console.log("✓ Received approval response:", response)

	if (response.approved) {
		console.log("✓ Request was approved")
	} else {
		console.log("✗ Request was denied")
	}

	// Test disconnect
	await channel.disconnect()
	console.log("✓ Disconnected from supervisor")
}

/**
 * Test approval manager with supervisor channel
 */
async function testApprovalManager() {
	console.log("\n=== Testing Approval Manager ===")

	const approvalManager = new ApprovalManager()
	const supervisorChannel = new MockSupervisorChannel("test-agent-2", true)

	// Set up supervisor channel
	await supervisorChannel.connect()
	approvalManager.setSupervisorChannel(supervisorChannel)
	console.log("✓ Approval manager configured with supervisor channel")

	// Test approval request
	const request: ApprovalRequest = {
		id: "test-request-2",
		agentId: "test-agent-2",
		tool: "delete_file",
		parameters: { path: "/important/file.txt" },
		context: { reason: "Testing approval flow through manager" },
		timestamp: Date.now(),
	}

	const result = await approvalManager.requestApproval(request)
	console.log("✓ Approval result:", result)

	if (result.approved) {
		console.log(`✓ Approved in ${result.duration}ms`)
	} else {
		console.log(`✗ Denied: ${result.reason}`)
	}

	// Test history
	const history = approvalManager.getApprovalHistory()
	console.log(`✓ Approval history: ${history.length} requests`)

	await supervisorChannel.disconnect()
}

/**
 * Test denial flow
 */
async function testDenialFlow() {
	console.log("\n=== Testing Denial Flow ===")

	const approvalManager = new ApprovalManager()
	const supervisorChannel = new MockSupervisorChannel("test-agent-3", false) // Auto-deny

	await supervisorChannel.connect()
	approvalManager.setSupervisorChannel(supervisorChannel)

	const request: ApprovalRequest = {
		id: "test-request-3",
		agentId: "test-agent-3",
		tool: "execute_command",
		parameters: { command: "dangerous command" },
		timestamp: Date.now(),
	}

	const result = await approvalManager.requestApproval(request)
	console.log("✓ Denial result:", result)

	if (!result.approved) {
		console.log("✓ Request was correctly denied")
	} else {
		console.log("✗ Request should have been denied!")
	}

	await supervisorChannel.disconnect()
}

/**
 * Test tool requires approval
 */
function testToolRequiresApproval() {
	console.log("\n=== Testing Tool Approval Requirements ===")

	const approvalManager = new ApprovalManager()

	// High-risk tools
	const highRiskTools = ["delete_file", "execute_command", "new_task", "condense"]

	for (const tool of highRiskTools) {
		const requires = approvalManager.toolRequiresApproval(tool)
		if (requires) {
			console.log(`✓ ${tool} requires approval`)
		} else {
			console.log(`✗ ${tool} should require approval!`)
		}
	}

	// Safe tools
	const safeTools = ["read_file", "list_files", "search_files"]

	for (const tool of safeTools) {
		const requires = approvalManager.toolRequiresApproval(tool)
		if (!requires) {
			console.log(`✓ ${tool} does not require approval`)
		} else {
			console.log(`✗ ${tool} should not require approval!`)
		}
	}
}

/**
 * Run all tests
 */
async function runTests() {
	console.log("====================================")
	console.log("Phase 4 Integration Tests")
	console.log("====================================")

	try {
		await testSupervisorChannel()
		await testApprovalManager()
		await testDenialFlow()
		testToolRequiresApproval()

		console.log("\n====================================")
		console.log("✓ All Phase 4 tests passed!")
		console.log("====================================\n")
	} catch (error) {
		console.error("\n====================================")
		console.error("✗ Phase 4 tests failed:")
		console.error(error)
		console.error("====================================\n")
		throw error
	}
}

// Export for use in test runners
export { runTests }
