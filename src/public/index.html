<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Society Agent</title>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #e6edf3; --muted: #8b949e; --accent: #58a6ff;
    --green: #3fb950; --red: #f85149; --yellow: #d29922;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }

  /* Header */
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px;
    display: flex; align-items: center; gap: 12px; }
  header h1 { font-size: 16px; font-weight: 600; }
  header .status { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--muted); }
  header .dot { width: 8px; height: 8px; border-radius: 50%; }
  header .dot.online { background: var(--green); }
  header .dot.offline { background: var(--red); }
  header .dot.paused { background: var(--yellow); }
  
  /* System pause banner */
  .pause-banner { 
    background: rgba(210,153,34,0.15); 
    border-bottom: 1px solid var(--yellow);
    padding: 8px 20px;
    display: none;
    align-items: center;
    gap: 10px;
    font-size: 13px;
  }
  .pause-banner.visible { display: flex; }
  .pause-banner .icon { font-size: 16px; }
  .pause-banner .text { color: var(--yellow); }
  .pause-banner button { 
    margin-left: auto;
    background: var(--yellow);
    color: var(--bg);
    border: none;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
  }
  .pause-banner button:hover { opacity: 0.9; }
  
  /* Pause/Resume button in header */
  .pause-btn { 
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    cursor: pointer;
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
    margin-right: 8px;
  }
  .pause-btn:hover { border-color: var(--yellow); color: var(--yellow); }
  .pause-btn.paused { border-color: var(--green); color: var(--green); }
  .pause-btn.paused:hover { border-color: var(--green); }

  /* Layout */
  .main { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 260px; background: var(--surface); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; overflow-y: auto; }
  .chat-area { flex: 1; display: flex; flex-direction: column; }

  /* Sidebar */
  .sidebar h2 { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;
    color: var(--muted); padding: 12px 16px 8px; }
  .stat-row { display: flex; justify-content: space-between; padding: 6px 16px; font-size: 13px; }
  .stat-row .label { color: var(--muted); }
  .stat-row .value { max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: default; }
  .stat-row .value.expandable { cursor: pointer; }
  .stat-row .value.expanded { white-space: normal; word-break: break-all; max-width: none; }
  .agent-card { padding: 10px 16px; border-bottom: 1px solid var(--border); cursor: pointer; }
  .agent-card:hover { background: rgba(88,166,255,0.08); }
  .agent-card .name { font-size: 13px; font-weight: 500; }
  .agent-card .role { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .agent-card .status-badge { display: inline-block; font-size: 10px; padding: 1px 6px;
    border-radius: 10px; margin-top: 4px; }
  .agent-card .status-badge.idle { background: rgba(139,148,158,0.2); color: var(--muted); }
  .agent-card .status-badge.working { background: rgba(88,166,255,0.2); color: var(--accent); }
  .agent-card .status-badge.completed { background: rgba(63,185,80,0.2); color: var(--green); }
  .agent-card .status-badge.error { background: rgba(248,81,73,0.2); color: var(--red); }

  /* Sidebar resizable */
  .sidebar { min-width: 180px; max-width: 600px; position: relative; }
  .sidebar-resize { position: absolute; top: 0; right: -3px; width: 6px; height: 100%;
    cursor: col-resize; z-index: 10; }
  .sidebar-resize:hover, .sidebar-resize.active { background: var(--accent); opacity: 0.5; }

  /* File tree */
  .file-tree { font-size: 12px; user-select: none; overflow-y: auto; flex: 1; }
  .tree-node { }
  .tree-row { display: flex; align-items: center; gap: 4px; padding: 3px 8px; cursor: pointer;
    white-space: nowrap; border: 2px solid transparent; transition: background 0.1s; }
  .tree-row:hover { background: rgba(88,166,255,0.08); }
  .tree-row.selected { background: rgba(88,166,255,0.15); }
  .tree-row.drag-over { border-color: var(--accent); background: rgba(88,166,255,0.12); }
  .tree-row .chevron { width: 16px; text-align: center; font-size: 10px; color: var(--muted);
    transition: transform 0.15s; flex-shrink: 0; }
  .tree-row .chevron.open { transform: rotate(90deg); }
  .tree-row .chevron.empty { visibility: hidden; }
  .tree-row .icon { width: 16px; text-align: center; flex-shrink: 0; font-size: 13px; }
  .tree-row .name { flex: 1; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
  .tree-row .size { color: var(--muted); font-size: 10px; margin-left: auto; flex-shrink: 0; }
  .tree-row .actions { display: flex; gap: 2px; opacity: 0; transition: opacity 0.15s; margin-left: 4px; }
  .tree-row:hover .actions { opacity: 1; }
  .tree-row .act-btn { background: none; border: none; color: var(--muted); cursor: pointer;
    font-size: 11px; padding: 0 2px; line-height: 1; }
  .tree-row .act-btn:hover { color: var(--text); }
  .tree-children { }
  .tree-children.collapsed { display: none; }
  .tree-row.dir-row .name { color: var(--accent); font-weight: 500; }
  /* Drag ghost */
  .drag-ghost { position: fixed; pointer-events: none; z-index: 1000; background: var(--surface);
    border: 1px solid var(--accent); border-radius: 4px; padding: 3px 10px; font-size: 12px;
    color: var(--text); opacity: 0.9; }

  /* Context menu */
  .ctx-menu { position: fixed; z-index: 200; background: var(--surface); border: 1px solid var(--border);
    border-radius: 6px; padding: 4px 0; min-width: 160px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
  .ctx-menu .ctx-item { padding: 6px 14px; font-size: 12px; cursor: pointer; display: flex;
    align-items: center; gap: 8px; }
  .ctx-menu .ctx-item:hover { background: rgba(88,166,255,0.12); }
  .ctx-menu .ctx-sep { height: 1px; background: var(--border); margin: 4px 0; }
  .ctx-menu .ctx-item .shortcut { margin-left: auto; color: var(--muted); font-size: 10px; }
  .ctx-menu .ctx-item.danger { color: var(--red); }
  .ctx-menu .ctx-item.danger:hover { background: rgba(248,81,73,0.12); }

  /* Inline rename input */
  .rename-input { background: var(--bg); border: 1px solid var(--accent); color: var(--text);
    font-size: 12px; padding: 1px 4px; border-radius: 3px; outline: none; width: 100%; font-family: inherit; }

  /* Upload area */
  .upload-area { border: 2px dashed var(--border); border-radius: 8px; padding: 16px; margin: 8px 12px;
    text-align: center; cursor: pointer; transition: border-color 0.2s, background 0.2s; font-size: 12px; color: var(--muted); }
  .upload-area:hover { border-color: var(--accent); }
  .upload-area.dragover { border-color: var(--green); background: rgba(63,185,80,0.08); }
  .upload-area input[type=file] { display: none; }
  .upload-row { display: flex; gap: 6px; margin: 4px 12px; }
  .upload-row .btn { flex: 1; font-size: 11px; padding: 5px 0; }

  /* API Key Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex;
    align-items: center; justify-content: center; z-index: 100; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px; width: 440px; max-width: 90vw; }
  .modal h2 { font-size: 18px; margin-bottom: 8px; }
  .modal p { font-size: 13px; color: var(--muted); margin-bottom: 16px; }
  .modal input { width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 14px; outline: none; }
  .modal input:focus { border-color: var(--accent); }
  .modal .actions { display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end; }

  /* Chat messages */
  .messages { flex: 1; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 12px; }
  .message { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 14px;
    line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
  .message.user { align-self: flex-end; background: #1f6feb; border-bottom-right-radius: 4px; }
  .message.assistant { align-self: flex-start; background: var(--surface); border: 1px solid var(--border);
    border-bottom-left-radius: 4px; }
  .message.system { align-self: center; color: var(--muted); font-size: 12px; font-style: italic; }
  .message.assistant .sender { font-size: 11px; color: var(--accent); margin-bottom: 4px; font-weight: 500; }
  .message code { background: rgba(110,118,129,0.2); padding: 1px 5px; border-radius: 3px; font-size: 13px; }
  .message pre { background: var(--bg); padding: 10px; border-radius: 6px; overflow-x: auto; margin: 8px 0; }
  .message pre code { background: none; padding: 0; }
  .typing { align-self: flex-start; color: var(--muted); font-size: 13px; }
  .typing::after { content: '...'; animation: dots 1.5s steps(3) infinite; }
  @keyframes dots { 0% { content: '.'; } 33% { content: '..'; } 66% { content: '...'; } }

  /* Input area */
  .input-area { padding: 12px 20px; border-top: 1px solid var(--border); background: var(--surface); }
  .input-row { display: flex; gap: 8px; }
  .input-row textarea { flex: 1; padding: 10px 14px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 14px; font-family: inherit;
    resize: none; outline: none; min-height: 44px; max-height: 200px; }
  .input-row textarea:focus { border-color: var(--accent); }

  /* Buttons */
  btn, button { cursor: pointer; }
  .btn { padding: 8px 16px; border-radius: 6px; border: none; font-size: 13px; font-weight: 500;
    cursor: pointer; transition: opacity 0.15s; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-secondary { background: var(--border); color: var(--text); }
  .btn-send { padding: 10px 20px; background: var(--accent); color: #fff; border: none;
    border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; }
  .btn-send:disabled { opacity: 0.4; cursor: not-allowed; }

  /* Attachments */
  .attach-btn { background: none; border: 1px solid var(--border); color: var(--muted); border-radius: 6px;
    padding: 8px 10px; cursor: pointer; font-size: 16px; line-height: 1; }
  .attach-btn:hover { color: var(--accent); border-color: var(--accent); }
  .attach-chips { display: flex; flex-wrap: wrap; gap: 6px; padding: 0 0 8px 0; }
  .attach-chip { display: flex; align-items: center; gap: 4px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 6px; padding: 3px 8px; font-size: 12px; color: var(--text); }
  .attach-chip img { width: 20px; height: 20px; border-radius: 3px; object-fit: cover; }
  .attach-chip .remove { cursor: pointer; color: var(--muted); margin-left: 2px; }
  .attach-chip .remove:hover { color: var(--red); }
  .msg-attachments { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
  .msg-attachments img { max-width: 200px; max-height: 150px; border-radius: 6px; cursor: pointer; }
  .msg-attachments .file-badge { font-size: 11px; color: var(--muted); background: rgba(110,118,129,0.15);
    padding: 2px 8px; border-radius: 4px; }

  /* Log panel */
  .log-panel { height: 180px; border-top: 1px solid var(--border); background: var(--bg);
    overflow-y: auto; padding: 8px 16px; font-family: 'SF Mono', 'Cascadia Code', monospace; font-size: 12px; }
  .log-entry { color: var(--muted); padding: 1px 0; }
  .log-entry.info { color: var(--accent); }
  .log-entry.warn { color: var(--yellow); }
  .log-entry.error { color: var(--red); }
  .log-entry .ts { color: #484f58; margin-right: 8px; }

  /* Welcome */
  .welcome { display: flex; flex-direction: column; align-items: center; justify-content: center;
    flex: 1; color: var(--muted); text-align: center; padding: 40px; }
  .welcome h2 { font-size: 20px; color: var(--text); margin-bottom: 8px; }
  .welcome p { font-size: 14px; max-width: 500px; line-height: 1.6; }
  .welcome .features { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px;
    text-align: left; }
  .welcome .feature { padding: 12px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; }
  .welcome .feature .title { font-size: 13px; color: var(--text); font-weight: 500; }
  .welcome .feature .desc { font-size: 12px; color: var(--muted); margin-top: 4px; }

  /* Tab bar */
  .tab-bar { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); }
  .tab-bar .tab { padding: 8px 20px; font-size: 13px; cursor: pointer; color: var(--muted);
    border-bottom: 2px solid transparent; transition: color 0.15s, border-color 0.15s; }
  .tab-bar .tab:hover { color: var(--text); }
  .tab-bar .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
  .tab-content.active { display: flex; }

  /* Terminal pane */
  .terminal-container { flex: 1; background: #000; padding: 4px; overflow: hidden; }
  .terminal-container .xterm { height: 100%; }
  .terminal-toolbar { display: flex; gap: 8px; padding: 8px 12px; background: var(--surface);
    border-bottom: 1px solid var(--border); align-items: center; font-size: 12px; }
  .terminal-toolbar select { background: var(--bg); border: 1px solid var(--border); color: var(--text);
    padding: 4px 8px; border-radius: 4px; font-size: 12px; }

  /* File viewer overlay */
  .file-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex;
    align-items: center; justify-content: center; z-index: 90; }
  .file-viewer-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    width: 80vw; max-width: 900px; max-height: 80vh; display: flex; flex-direction: column; overflow: hidden; }
  .file-viewer-panel.pdf-viewer { max-width: 1100px; height: 90vh; max-height: 90vh; }
  .file-viewer-header { display: flex; align-items: center; padding: 12px 16px;
    border-bottom: 1px solid var(--border); gap: 8px; }
  .file-viewer-header .title { flex: 1; font-size: 14px; font-weight: 500; }
  .file-viewer-header .meta { font-size: 12px; color: var(--muted); }
  .file-viewer-header .view-toggle { display: flex; gap: 4px; }
  .file-viewer-header .view-toggle button { background: var(--bg); border: 1px solid var(--border);
    color: var(--muted); padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer; }
  .file-viewer-header .view-toggle button.active { background: var(--accent); color: white; border-color: var(--accent); }
  .file-viewer-header .close-btn { background: none; border: none; color: var(--muted); font-size: 20px;
    cursor: pointer; padding: 0 4px; line-height: 1; }
  .file-viewer-header .close-btn:hover { color: var(--text); }
  .file-viewer-body { flex: 1; overflow: auto; padding: 16px; }
  .file-viewer-body pre { margin: 0; white-space: pre-wrap; word-break: break-all;
    font-family: 'SF Mono', 'Cascadia Code', monospace; font-size: 13px; line-height: 1.5; }
  .file-viewer-body iframe { width: 100%; height: 100%; border: none; }
  .file-viewer-body.pdf-body { padding: 0; }
  /* Markdown rendered view */
  .file-viewer-body .markdown-body { font-size: 14px; line-height: 1.6; padding: 8px; }
  .file-viewer-body .markdown-body h1 { font-size: 1.8em; margin: 0.5em 0 0.3em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
  .file-viewer-body .markdown-body h2 { font-size: 1.5em; margin: 0.4em 0 0.2em; border-bottom: 1px solid var(--border); padding-bottom: 0.2em; }
  .file-viewer-body .markdown-body h3 { font-size: 1.25em; margin: 0.3em 0 0.15em; }
  .file-viewer-body .markdown-body p { margin: 0.5em 0; }
  .file-viewer-body .markdown-body ul, .file-viewer-body .markdown-body ol { margin: 0.5em 0; padding-left: 1.5em; }
  .file-viewer-body .markdown-body li { margin: 0.2em 0; }
  .file-viewer-body .markdown-body code { background: var(--bg); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
  .file-viewer-body .markdown-body pre { background: var(--bg); padding: 12px; border-radius: 8px;
    overflow-x: auto; margin: 0.5em 0; }
  .file-viewer-body .markdown-body pre code { background: none; padding: 0; }
  .file-viewer-body .markdown-body blockquote { border-left: 4px solid var(--accent); margin: 0.5em 0;
    padding-left: 1em; color: var(--muted); }
  .file-viewer-body .markdown-body table { border-collapse: collapse; width: 100%; margin: 0.5em 0; }
  .file-viewer-body .markdown-body th, .file-viewer-body .markdown-body td { border: 1px solid var(--border);
    padding: 8px 12px; text-align: left; }
  .file-viewer-body .markdown-body th { background: var(--bg); font-weight: 600; }
  .file-viewer-body .markdown-body a { color: var(--accent); text-decoration: none; }
  .file-viewer-body .markdown-body a:hover { text-decoration: underline; }
  .file-viewer-body .markdown-body img { max-width: 100%; height: auto; border-radius: 8px; }

  /* Agent selector (above chat input) */
  .agent-selector { display: flex; align-items: center; gap: 8px; padding: 6px 20px;
    border-bottom: 1px solid var(--border); background: var(--surface); font-size: 12px; }
  .agent-selector label { color: var(--muted); }
  .agent-selector select { background: var(--bg); border: 1px solid var(--border); color: var(--text);
    padding: 4px 8px; border-radius: 4px; font-size: 12px; min-width: 140px; }
  .agent-selector .agent-info { color: var(--muted); font-size: 11px; margin-left: 4px; }
  .agent-selector .agent-indicator { display: inline-block; width: 6px; height: 6px; border-radius: 50%;
    margin-right: 4px; }
  .agent-selector .agent-indicator.active { background: var(--green); }
  .agent-selector .agent-indicator.idle { background: var(--yellow); }
  .agent-selector .agent-indicator.disabled { background: var(--red); }

  /* Project management panel (tab) */
  .projects-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 12px; padding: 16px 20px; overflow-y: auto; flex: 1; }
  .project-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px; display: flex; flex-direction: column; gap: 10px; transition: border-color 0.2s; }
  .project-card:hover { border-color: var(--accent); }
  .project-card .project-header { display: flex; align-items: center; gap: 10px; }
  .project-card .project-icon { width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center; font-size: 20px;
    background: rgba(88,166,255,0.15); }
  .project-card .project-meta { flex: 1; }
  .project-card .project-name { font-size: 15px; font-weight: 600; }
  .project-card .project-desc { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .project-card .project-folder { font-size: 11px; color: var(--accent); font-family: monospace; }
  .project-card .project-agents { display: flex; flex-wrap: wrap; gap: 6px; }
  .project-card .project-agent-chip { font-size: 11px; padding: 2px 8px; border-radius: 10px;
    background: rgba(88,166,255,0.08); color: var(--text); border: 1px solid var(--border); display: flex; align-items: center; gap: 4px; }
  .project-card .project-agent-chip .chip-dot { width: 6px; height: 6px; border-radius: 50%; }
  .project-card .project-agent-chip .chip-dot.supervisor { background: var(--yellow); }
  .project-card .project-agent-chip .chip-dot.worker { background: var(--green); }
  .project-card .project-stats { display: flex; gap: 12px; font-size: 11px; color: var(--muted); }
  .project-card .project-actions { display: flex; gap: 6px; margin-top: 4px; }
  .project-card .project-actions .btn { font-size: 11px; padding: 4px 10px; }
  /* Society Agent start - Git badge styling */
  .project-card .git-badge { font-size: 10px; padding: 2px 6px; border-radius: 8px;
    background: rgba(63,185,80,0.15); color: var(--green); cursor: pointer; margin-left: 6px; }
  .project-card .git-badge:hover { background: rgba(63,185,80,0.25); }
  /* Society Agent end */
  .project-add-card { background: var(--surface); border: 2px dashed var(--border); border-radius: 10px;
    padding: 30px 16px; display: flex; align-items: center; justify-content: center;
    font-size: 14px; color: var(--muted); cursor: pointer; transition: border-color 0.2s, color 0.2s; }
  .project-add-card:hover { border-color: var(--accent); color: var(--accent); }
  .agent-add-card { background: transparent; border: 2px dashed var(--border); border-radius: 10px;
    display: flex; align-items: center; justify-content: center; min-height: 140px;
    cursor: pointer; color: var(--muted); font-size: 14px; transition: border-color 0.2s; }
  .agent-add-card:hover { border-color: var(--accent); color: var(--accent); }

  /* Agent edit modal */
  .modal.wide { width: 560px; }
  .modal .form-group { margin-bottom: 12px; }
  .modal .form-group label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
  .modal .form-group input, .modal .form-group textarea, .modal .form-group select {
    width: 100%; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 13px; outline: none; font-family: inherit; }
  .modal .form-group input:focus, .modal .form-group textarea:focus { border-color: var(--accent); }
  .modal .form-group textarea { min-height: 80px; resize: vertical; }
  .modal .form-row { display: flex; gap: 12px; }
  .modal .form-row .form-group { flex: 1; }
  .modal .form-group .checkbox-row { display: flex; align-items: center; gap: 8px; }
  .modal .form-group .checkbox-row input { width: auto; }
</style>
</head>
<body>

<header>
  <h1>&#9670; Society Agent</h1>
  <div class="status">
    <span class="dot" id="statusDot"></span>
    <span id="statusText">Connecting...</span>
    <!-- Society Agent - manual reconnect button -->
    <button id="reconnectBtn" onclick="manualReconnect()" style="margin-left:8px;background:none;border:1px solid var(--border);color:var(--muted);cursor:pointer;font-size:11px;padding:2px 8px;border-radius:4px;display:none" title="Click to reconnect">‚Üª Reconnect</button>
  </div>
  <div style="flex:1"></div>
  <!-- Society Agent - System pause/resume for external oversight -->
  <button class="pause-btn" id="pauseBtn" onclick="toggleSystemPause()" title="Pause system for maintenance">
    <span id="pauseBtnIcon">‚è∏</span>
    <span id="pauseBtnText">Maintenance</span>
  </button>
  <!-- Society Agent - Clear & Reset button for troubleshooting -->
  <button class="btn btn-secondary" onclick="clearAndReset()" style="font-size:11px;margin-right:8px;color:var(--yellow)" title="Clear all state and reload">&#9888; Reset</button>
  <button class="btn btn-secondary" onclick="showApiKeyModal()" style="font-size:12px">&#9881; Settings</button>
</header>

<!-- Society Agent - System pause banner -->
<div class="pause-banner" id="pauseBanner">
  <span class="icon">‚ö†Ô∏è</span>
  <span class="text"><strong>System Paused</strong> ‚Äî Maintenance mode active. New requests are blocked.</span>
  <span id="pauseReason" style="color:var(--muted);font-size:12px"></span>
  <button onclick="resumeSystem()">‚ñ∂Ô∏è Resume System</button>
</div>

<div class="main">
  <div class="sidebar" id="sidebar" style="width:280px">
    <div class="sidebar-resize" id="sidebarResize"></div>
    <!-- System Info -->
    <h2>System</h2>
    <div class="stat-row"><span class="label">Status</span><span class="value" id="sysStatus">-</span></div>
    <div class="stat-row"><span class="label">Messages</span><span class="value" id="msgCount">0</span></div>
    <div class="stat-row"><span class="label">API Key</span><span class="value" id="apiKeyStatus">-</span></div>
    <div class="stat-row"><span class="label">Output</span><span class="value expandable" id="outputDir" title="" onclick="this.classList.toggle('expanded')">projects/</span></div>
    <div class="stat-row"><span class="label">Files</span><span class="value" id="fileCount">0</span></div>
    <!-- Society Agent start - usage tracking display -->
    <div class="stat-row"><span class="label">üí∞ Tokens</span>
      <span class="value" id="tokenCount" title="Click to see details" style="cursor:pointer" onclick="showUsageDetails()">0</span>
    </div>
    <div class="stat-row"><span class="label">üíµ Est. Cost</span><span class="value" id="costDisplay" style="color:var(--green)">$0.00</span></div>
    <div class="stat-row"><span class="label">üìä API Calls</span><span class="value" id="callCount">0</span></div>
    <div class="stat-row" title="Click to configure limits" style="cursor:pointer" onclick="showLimitsDialog()">
      <span class="label">‚ö†Ô∏è Limit</span>
      <span class="value" id="limitDisplay" style="color:var(--green)">$100</span>
    </div>
    <!-- Society Agent end -->

    <!-- File Explorer -->
    <h2 style="margin-top:12px;display:flex;align-items:center;gap:6px">
      Explorer
      <span style="flex:1"></span>
      <button class="act-btn" onclick="promptNewFileInTree()" title="New File" style="font-size:14px;background:none;border:none;color:var(--muted);cursor:pointer">&#128196;+</button>
      <button class="act-btn" onclick="promptNewFolderInTree()" title="New Folder" style="font-size:14px;background:none;border:none;color:var(--muted);cursor:pointer">&#128193;+</button>
      <button class="act-btn" onclick="refreshFiles()" title="Refresh" style="font-size:13px;background:none;border:none;color:var(--muted);cursor:pointer">&#8635;</button>
    </h2>
    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()" style="margin:4px 8px;padding:8px">
      &#128228; Drop files or click
      <input type="file" id="fileInput" multiple onchange="handleFileSelect(event)">
    </div>
    <div id="fileTree" class="file-tree">
      <div style="padding:16px;color:var(--muted);font-size:12px">No files yet</div>
    </div>

    <!-- Projects -->
    <h2 style="margin-top:8px">Projects</h2>
    <div id="projectList">
      <div style="padding:8px 16px;color:var(--muted);font-size:12px">No projects</div>
    </div>

    <!-- Society Agent start - Global Skills section -->
    <h2 style="margin-top:8px;display:flex;align-items:center;gap:6px">
      üéØ Global Skills
      <span style="flex:1"></span>
      <button class="act-btn" onclick="refreshSkills()" title="Refresh" style="font-size:13px;background:none;border:none;color:var(--muted);cursor:pointer">&#8635;</button>
    </h2>
    <div id="skillsList" style="font-size:12px">
      <div style="padding:8px 16px;color:var(--muted)">Loading...</div>
    </div>
    <!-- Society Agent end -->

    <!-- Society Agent start - Global MCPs section -->
    <h2 style="margin-top:8px;display:flex;align-items:center;gap:6px">
      üîå Global MCPs
      <span style="flex:1"></span>
      <button class="act-btn" onclick="refreshMcps()" title="Refresh" style="font-size:13px;background:none;border:none;color:var(--muted);cursor:pointer">&#8635;</button>
    </h2>
    <div id="mcpsList" style="font-size:12px">
      <div style="padding:8px 16px;color:var(--muted)">Loading...</div>
    </div>
    <!-- Society Agent end -->
  </div>

  <div class="chat-area">
    <div class="tab-bar">
      <div class="tab active" onclick="switchTab('chat')" id="tabChat">&#128172; Chat</div>
      <div class="tab" onclick="switchTab('projects')" id="tabProjects">&#128193; Projects</div>
      <div class="tab" onclick="switchTab('terminal')" id="tabTerminal">&#9000; Terminal</div>
    </div>

    <div class="tab-content active" id="paneChat">
    <!-- Agent selector bar (organized by project) -->
    <div class="agent-selector" id="agentSelector">
      <label>Agent:</label>
      <select id="agentSelect" onchange="onAgentChange()">
        <option value="">Default (Society Agent)</option>
      </select>
      <span class="agent-info" id="agentSelectInfo"></span>
    </div>
    <div class="messages" id="messages">
      <div class="welcome" id="welcome">
        <h2>Society Agent Server</h2>
        <p>Multi-agent collaboration system. Chat naturally, or ask it to build something &mdash; files appear in the sidebar.</p>
        <div class="features">
          <div class="feature">
            <div class="title">&#128172; Chat</div>
            <div class="desc">Conversational AI with persistent memory</div>
          </div>
          <div class="feature">
            <div class="title">&#128196; Create Files</div>
            <div class="desc">"Build a calculator" &rarr; files in projects/</div>
          </div>
          <div class="feature">
            <div class="title">&#129302; Multi-Agent</div>
            <div class="desc">Complex tasks get supervisor + worker teams</div>
          </div>
          <div class="feature">
            <div class="title">&#128065; Workspace View</div>
            <div class="desc">See created files, click to view contents</div>
          </div>
        </div>
      </div>
    </div>

    <div class="input-area">
      <div id="attachChips" class="attach-chips" style="display:none"></div>
      <div class="input-row">
        <button class="attach-btn" onclick="document.getElementById('chatFileInput').click()" title="Attach files">&#128206;</button>
        <input type="file" id="chatFileInput" multiple style="display:none" onchange="handleChatAttach(event)" accept="image/*,.txt,.md,.json,.js,.ts,.py,.html,.css,.csv,.xml,.yaml,.yml,.log,.sh,.sql">
        <textarea id="input" placeholder="Type a message... (Enter to send, Shift+Enter for newline)"
          rows="1" autofocus></textarea>
        <button class="btn-send" id="sendBtn" onclick="sendMessage()">Send</button>
        <button class="btn-stop" id="stopBtn" onclick="stopAgent()" title="Stop agent">&#9632; Stop</button>
      </div>
    </div>

    <div class="log-panel" id="logPanel"></div>
  </div><!-- /paneChat -->

    <!-- Projects management pane -->
    <div class="tab-content" id="paneProjects">
      <div style="padding:12px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px">
        <h3 style="font-size:14px;font-weight:600;flex:1">Projects</h3>
        <span style="font-size:12px;color:var(--muted)" id="projectCountInfo">-</span>
      </div>
      <div class="projects-grid" id="projectsGrid">
        <div style="padding:20px;color:var(--muted);font-size:13px">Loading projects...</div>
      </div>
    </div><!-- /paneProjects -->

    <div class="tab-content" id="paneTerminal">
      <div class="terminal-toolbar">
        <span style="color:var(--muted)">Shell:</span>
        <select id="termShell">
          <option value="/bin/bash">bash</option>
          <option value="/bin/sh">sh</option>
        </select>
        <span style="color:var(--muted);margin-left:8px">CWD:</span>
        <span id="termCwd" style="color:var(--text)">/workspace</span>
        <div style="flex:1"></div>
        <button class="btn btn-secondary" onclick="reconnectTerminal()" style="font-size:11px;padding:3px 10px">&#8635; Reconnect</button>
      </div>
      <div class="terminal-container" id="terminalContainer"></div>
    </div><!-- /paneTerminal -->
  </div>
</div>

<!-- Settings Modal (replaces old apiKeyModal) -->
<div class="modal-overlay" id="apiKeyModal" style="display:none">
  <div class="modal wide">
    <h2>‚öôÔ∏è Server Settings</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px">Configure LLM provider and model. These are the defaults - individual agents can override.</p>
    
    <div class="form-group">
      <label>Provider</label>
      <select id="settingsProvider" onchange="onProviderChange()">
        <option value="anthropic">Anthropic (Claude direct)</option>
        <option value="openrouter">OpenRouter (multi-model)</option>
        <option value="openai">OpenAI</option>
        <option value="gemini">Google Gemini</option>
        <option value="deepseek">DeepSeek</option>
        <option value="groq">Groq</option>
        <option value="mistral">Mistral</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Model</label>
      <select id="settingsModel"></select>
      <span style="font-size:11px;color:var(--muted)" id="settingsModelCost"></span>
    </div>
    
    <div class="form-group">
      <label id="settingsApiKeyLabel">API Key</label>
      <input type="password" id="settingsApiKey" placeholder="sk-...">
      <span style="font-size:11px;color:var(--muted)" id="settingsApiKeyStatus"></span>
    </div>
    
    <details style="margin-top:16px">
      <summary style="cursor:pointer;font-size:12px;color:var(--muted)">Advanced Settings</summary>
      <div style="margin-top:12px">
        <div class="form-group">
          <label>Max Tokens</label>
          <input type="number" id="settingsMaxTokens" value="16384" min="1000" max="200000">
        </div>
        <div class="form-group">
          <label>Temperature</label>
          <input type="number" id="settingsTemperature" value="0.7" min="0" max="2" step="0.1">
        </div>
      </div>
    </details>
    
    <div class="actions">
      <button class="btn btn-secondary" onclick="hideApiKeyModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>
</div>

<!-- Agent Edit/Create Modal -->
<div class="modal-overlay" id="projectModal" style="display:none">
  <div class="modal wide">
    <h2 id="projectModalTitle">Create Project</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px" id="projectModalDesc">Create a project to organize agents around a shared folder and knowledge base.</p>
    <!-- Society Agent start - simplified: name becomes folder/id -->
    <div class="form-group">
      <label>Project Name (also used as folder name)</label>
      <input type="text" id="projectFormName" placeholder="my-project">
      <span style="font-size:11px;color:var(--muted)">Will create folder: <code id="projectFolderPreview">projects/</code></span>
    </div>
    <!-- Society Agent end -->
    <div class="form-group">
      <label>Description</label>
      <input type="text" id="projectFormDesc" placeholder="What is this project about?">
    </div>
    <div class="actions">
      <button class="btn btn-secondary" onclick="hideProjectModal()">Cancel</button>
      <button class="btn btn-primary" id="projectFormSubmit" onclick="submitProjectForm()">Create</button>
    </div>
  </div>
</div>

<!-- Society Agent start - Git Integration Modals -->
<!-- Load from Git Modal -->
<div class="modal-overlay" id="gitModal" style="display:none">
  <div class="modal wide">
    <h2>&#128268; Load Project from Git</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Clone a repository from GitLab or GitHub. Agents will work in the cloned workspace.</p>
    
    <div class="form-group">
      <label>Project Name</label>
      <input type="text" id="gitFormName" placeholder="my-project" oninput="updateGitFolderPreview()">
      <span style="font-size:11px;color:var(--muted)">Will clone to: <code id="gitFolderPreview">projects/</code></span>
    </div>
    
    <div class="form-group">
      <label>Repository URL</label>
      <input type="text" id="gitFormUrl" placeholder="git@gitlab.com:user/repo.git or https://...">
    </div>
    
    <div class="form-group">
      <label>Branch / Ref</label>
      <input type="text" id="gitFormRef" placeholder="main" value="main">
    </div>
    
    <div class="form-group">
      <label>Credential (for private repos)</label>
      <select id="gitFormCredential" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)">
        <option value="">None (public repo)</option>
      </select>
      <button onclick="showCredentialsModal()" style="margin-top:8px;font-size:11px;background:none;border:1px solid var(--border);color:var(--muted);padding:4px 8px;border-radius:4px;cursor:pointer">
        &#128273; Manage Credentials
      </button>
    </div>
    
    <div class="form-group">
      <label>Description (optional)</label>
      <input type="text" id="gitFormDesc" placeholder="What is this project about?">
    </div>
    
    <div id="gitFormStatus" style="display:none;margin-bottom:12px;padding:8px;border-radius:4px;font-size:12px"></div>
    
    <div class="actions">
      <button class="btn btn-secondary" onclick="hideGitModal()">Cancel</button>
      <button class="btn btn-primary" id="gitFormSubmit" onclick="submitGitForm()">&#128268; Clone & Create</button>
    </div>
  </div>
</div>

<!-- Credentials Management Modal -->
<div class="modal-overlay" id="credentialsModal" style="display:none">
  <div class="modal wide">
    <h2>&#128273; Git Credentials</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Manage SSH keys and access tokens for private repositories.</p>
    
    <div id="credentialsList" style="margin-bottom:16px;max-height:200px;overflow-y:auto">
      <div style="color:var(--muted);font-size:12px;padding:8px">Loading...</div>
    </div>
    
    <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
    <h3 style="font-size:14px;margin-bottom:12px">Add New Credential</h3>
    
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="credFormName" placeholder="GitLab Deploy Key - myproject">
    </div>
    
    <div class="form-group">
      <label>Type</label>
      <select id="credFormType" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)" onchange="updateCredFormPlaceholder()">
        <option value="ssh-key">SSH Key (private key)</option>
        <option value="token">Personal Access Token</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Host (e.g., gitlab.com, github.com, or * for any)</label>
      <input type="text" id="credFormHost" placeholder="gitlab.com">
    </div>
    
    <div class="form-group">
      <label id="credFormSecretLabel">Private Key</label>
      <textarea id="credFormSecret" rows="4" placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;..." style="width:100%;font-family:monospace;font-size:11px;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);resize:vertical"></textarea>
    </div>
    
    <div class="actions">
      <button class="btn btn-secondary" onclick="hideCredentialsModal()">Close</button>
      <button class="btn btn-primary" onclick="addCredential()">&#10003; Add Credential</button>
    </div>
  </div>
</div>

<!-- Git Project Actions Modal (pull, push, branches) -->
<div class="modal-overlay" id="gitActionsModal" style="display:none">
  <div class="modal wide">
    <h2 id="gitActionsTitle">&#128268; Git Operations</h2>
    <div id="gitActionsContent">Loading...</div>
    <div class="actions" style="margin-top:16px">
      <button class="btn btn-secondary" onclick="hideGitActionsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Push to GitLab Modal -->
<div class="modal-overlay" id="pushToGitLabModal" style="display:none">
  <div class="modal">
    <h2>&#128268; Push to GitLab</h2>
    <p style="color:var(--text-muted);margin-bottom:16px">Create a new GitLab repository and push this local project</p>
    
    <input type="hidden" id="pushGitLabProjectId" />
    
    <div class="form-group">
      <label>Credential (GitLab Token)</label>
      <select id="pushGitLabCredential" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)">
        <option value="">Loading...</option>
      </select>
      <small style="color:var(--text-muted);display:block;margin-top:4px">Must be a Personal Access Token with api scope</small>
    </div>
    
    <div class="form-group">
      <label>Repository Name</label>
      <input type="text" id="pushGitLabRepoName" placeholder="my-project" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)" />
    </div>
    
    <div class="form-group">
      <label>Namespace (optional)</label>
      <select id="pushGitLabNamespace" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)">
        <option value="">Select credential first...</option>
      </select>
      <small style="color:var(--text-muted);display:block;margin-top:4px">Leave empty for personal namespace</small>
    </div>
    
    <div class="form-group">
      <label>Visibility</label>
      <select id="pushGitLabVisibility" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text)">
        <option value="private" selected>Private</option>
        <option value="internal">Internal</option>
        <option value="public">Public</option>
      </select>
    </div>
    
    <div id="pushGitLabError" style="display:none;padding:8px;background:var(--red);color:white;border-radius:4px;margin-bottom:12px"></div>
    <div id="pushGitLabSuccess" style="display:none;padding:8px;background:var(--green);color:white;border-radius:4px;margin-bottom:12px"></div>
    
    <div class="actions">
      <button class="btn btn-secondary" onclick="hidePushToGitLabModal()">Cancel</button>
      <button class="btn btn-primary" id="pushGitLabBtn" onclick="pushToGitLab()">&#128268; Create & Push</button>
    </div>
  </div>
</div>
<!-- Society Agent end - Git Integration Modals -->

<script>
const API = window.location.origin;
// Society Agent start - Enhanced Socket.IO with auto-reconnect and status

// Global error handler - prevent page from breaking
window.onerror = function(msg, url, line, col, error) {
  console.error('Global error:', msg, error);
  try { addLog('error', `JS Error: ${msg}`); } catch {}
  return false; // Don't suppress error in console
};

// Handle unhandled promise rejections
window.addEventListener('unhandledrejection', function(event) {
  console.error('Unhandled rejection:', event.reason);
  try { addLog('error', `Promise Error: ${event.reason}`); } catch {}
});

const socket = io(API, {
  reconnection: true,
  reconnectionAttempts: Infinity,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
  timeout: 20000,
  forceNew: false, // Reuse connection
});
let messageCount = 0;
let isStreaming = false;
let currentStreamEl = null;
let streamText = '';
let chatAttachments = []; // { name, type, dataUrl, base64, mediaType }
let reconnectAttempt = 0;

// ============================================================================
// Socket.IO Events
// ============================================================================

socket.on('connect', () => {
  try {
    reconnectAttempt = 0;
    setStatus(true);
    addLog('info', 'Connected to Society Agent server');
    checkApiKey();
    checkServerStatus();
    checkSystemPauseState(); // Society Agent - check if system is paused
    // Reload data after reconnect
    loadProjects();
  } catch (e) {
    console.error('Error in connect handler:', e);
  }
});

socket.on('disconnect', (reason) => {
  setStatus(false);
  addLog('warn', `Disconnected: ${reason}`);
  if (reason === 'io server disconnect') {
    // Server disconnected us, try to reconnect
    socket.connect();
  }
});

socket.on('reconnect_attempt', (attempt) => {
  reconnectAttempt = attempt;
  setStatus(false, `Reconnecting... (${attempt})`);
  addLog('info', `Reconnection attempt ${attempt}`);
});

socket.on('reconnect', (attempt) => {
  addLog('info', `Reconnected after ${attempt} attempts`);
});

socket.on('reconnect_error', (error) => {
  addLog('error', `Reconnection error: ${error.message}`);
});

socket.on('reconnect_failed', () => {
  addLog('error', 'Reconnection failed - please refresh page');
  setStatus(false, 'Disconnected - refresh page');
});
// Society Agent end

// Society Agent start - Usage tracking events
socket.on('usage', (data) => {
  // Individual usage entry - update totals
  console.log('[Usage]', data);
  fetchUsageSummary();
});

socket.on('usage-summary', (summary) => {
  updateUsageDisplay(summary);
});

socket.on('activity', (data) => {
  console.log('[Activity]', data.type, data.summary);
  // Could show a toast or update activity feed
});

function updateUsageDisplay(summary) {
  const tokenEl = document.getElementById('tokenCount');
  const costEl = document.getElementById('costDisplay');
  const callEl = document.getElementById('callCount');
  
  if (tokenEl) tokenEl.textContent = formatNumber(summary.totalTokens);
  if (costEl) {
    const cost = summary.totalCostUsd;
    costEl.textContent = cost < 0.01 ? `$${(cost * 100).toFixed(2)}¬¢` : `$${cost.toFixed(4)}`;
    // Color code by cost
    if (cost > 1) costEl.style.color = 'var(--red)';
    else if (cost > 0.1) costEl.style.color = 'var(--yellow)';
    else costEl.style.color = 'var(--green)';
  }
  if (callEl) callEl.textContent = summary.callCount;
}

function formatNumber(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
  return n.toString();
}

async function fetchUsageSummary() {
  try {
    const res = await fetch('/api/usage');
    if (res.ok) {
      const summary = await res.json();
      updateUsageDisplay(summary);
    }
  } catch (e) {
    console.warn('Failed to fetch usage:', e);
  }
}

function showUsageDetails() {
  fetch('/api/usage').then(r => r.json()).then(summary => {
    let html = `<h3>Token Usage Summary</h3>
      <p><strong>Total:</strong> ${formatNumber(summary.totalTokens)} tokens</p>
      <p><strong>Input:</strong> ${formatNumber(summary.totalInputTokens)} | <strong>Output:</strong> ${formatNumber(summary.totalOutputTokens)}</p>
      <p><strong>Cost:</strong> $${summary.totalCostUsd.toFixed(4)}</p>
      <p><strong>API Calls:</strong> ${summary.callCount}</p>
      <h4 style="margin-top:12px">By Agent:</h4>
      <ul style="font-size:12px;margin:0;padding-left:20px">`;
    for (const [agentId, data] of Object.entries(summary.byAgent || {})) {
      html += `<li>${agentId}: ${formatNumber(data.inputTokens + data.outputTokens)} tokens ($${data.costUsd.toFixed(4)}, ${data.callCount} calls)</li>`;
    }
    html += '</ul>';
    
    // Simple alert-style modal
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    overlay.innerHTML = `<div class="modal" style="max-width:500px">
      ${html}
      <div class="actions"><button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Close</button></div>
    </div>`;
    document.body.appendChild(overlay);
  }).catch(e => alert('Failed to load usage: ' + e.message));
}

// Fetch initial usage on connect
setTimeout(fetchUsageSummary, 1000);

// Society Agent start - Token limits tracking
let currentLimits = { maxCostGlobal: 100 };

socket.on('token-limits', (limits) => {
  currentLimits = limits;
  updateLimitDisplay();
});

socket.on('token-usage', (data) => {
  currentLimits = data.limits;
  updateLimitDisplay(data.globalUsage?.cost);
});

socket.on('token-limit-exceeded', (data) => {
  addLog('warn', `‚ö†Ô∏è Token limit exceeded: ${data.message}`);
  // Show alert
  const limitEl = document.getElementById('limitDisplay');
  if (limitEl) {
    limitEl.style.color = 'var(--red)';
    limitEl.textContent = '‚õî LIMIT';
  }
});

socket.on('token-usage-reset', (data) => {
  addLog('info', `Token usage reset (${data.scope})`);
  fetchLimits();
});

function updateLimitDisplay(currentCost) {
  const limitEl = document.getElementById('limitDisplay');
  if (!limitEl) return;
  
  const limit = currentLimits.maxCostGlobal || 100;
  const cost = currentCost || 0;
  const percent = (cost / limit) * 100;
  
  if (percent >= 100) {
    limitEl.style.color = 'var(--red)';
    limitEl.textContent = '‚õî LIMIT';
  } else if (percent >= 75) {
    limitEl.style.color = 'var(--yellow)';
    limitEl.textContent = `$${limit} (${percent.toFixed(0)}%)`;
  } else {
    limitEl.style.color = 'var(--muted)';
    limitEl.textContent = `$${limit}`;
  }
}

async function fetchLimits() {
  try {
    const res = await fetch('/api/limits');
    if (res.ok) {
      currentLimits = await res.json();
      updateLimitDisplay();
    }
  } catch (e) {
    console.warn('Failed to fetch limits:', e);
  }
}

async function showLimitsDialog() {
  try {
    const [limitsRes, usageRes] = await Promise.all([
      fetch('/api/limits'),
      fetch('/api/limits/usage')
    ]);
    const limits = await limitsRes.json();
    const usage = await usageRes.json();
    
    const overlay = document.createElement('div');
    overlay.className = 'modal-overlay';
    overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
    overlay.innerHTML = `<div class="modal" style="max-width:500px">
      <h3>Token Limits & Usage</h3>
      
      <h4 style="margin:12px 0 8px">Current Usage</h4>
      <div style="font-size:13px;margin-bottom:12px">
        <div>Global: ${formatNumber(usage.global?.tokens || 0)} tokens / $${(usage.global?.cost || 0).toFixed(4)}</div>
      </div>
      
      <h4 style="margin:12px 0 8px">Limits (per session)</h4>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
        <label>Max $ per Agent:</label>
        <input type="number" id="limitAgentCost" value="${limits.maxCostPerAgent}" step="1" min="0" style="width:80px">
        
        <label>Max $ per Project:</label>
        <input type="number" id="limitProjectCost" value="${limits.maxCostPerProject}" step="5" min="0" style="width:80px">
        
        <label>Max $ Global:</label>
        <input type="number" id="limitGlobalCost" value="${limits.maxCostGlobal}" step="10" min="0" style="width:80px">
        
        <label>Max Tokens/Agent:</label>
        <input type="number" id="limitAgentTokens" value="${limits.maxTokensPerAgent}" step="100000" min="0" style="width:100px">
      </div>
      
      <div class="actions" style="margin-top:16px;display:flex;gap:8px">
        <button class="btn" onclick="resetUsage()">Reset Usage</button>
        <span style="flex:1"></span>
        <button class="btn" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="saveLimits()">Save</button>
      </div>
    </div>`;
    document.body.appendChild(overlay);
  } catch (e) {
    alert('Failed to load limits: ' + e.message);
  }
}

async function saveLimits() {
  const newLimits = {
    maxCostPerAgent: parseFloat(document.getElementById('limitAgentCost').value) || 5,
    maxCostPerProject: parseFloat(document.getElementById('limitProjectCost').value) || 25,
    maxCostGlobal: parseFloat(document.getElementById('limitGlobalCost').value) || 100,
    maxTokensPerAgent: parseInt(document.getElementById('limitAgentTokens').value) || 1000000,
  };
  
  try {
    const res = await fetch('/api/limits', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newLimits)
    });
    if (res.ok) {
      currentLimits = (await res.json()).limits;
      updateLimitDisplay();
      document.querySelector('.modal-overlay')?.remove();
      addLog('info', 'Token limits updated');
    } else {
      throw new Error('Failed to save');
    }
  } catch (e) {
    alert('Failed to save limits: ' + e.message);
  }
}

async function resetUsage() {
  if (!confirm('Reset all token usage counters? This will allow agents to run again if they hit limits.')) return;
  
  try {
    const res = await fetch('/api/limits/reset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ scope: 'all' })
    });
    if (res.ok) {
      document.querySelector('.modal-overlay')?.remove();
      addLog('info', 'Token usage reset');
      fetchLimits();
    }
  } catch (e) {
    alert('Failed to reset: ' + e.message);
  }
}

setTimeout(fetchLimits, 1500);
// Society Agent end

// Streaming agent messages
let streamDidFire = false;
socket.on('agent-message', (data) => {
  // Society Agent - Filter to only show messages for selected agent
  // If an agent is selected and this message is from a different agent, ignore it
  if (selectedAgentId && data.agentId && data.agentId !== selectedAgentId) {
    // Log it but don't display in chat
    addLog('info', `[${data.agentName || data.agentId}] ${(data.message || '').substring(0, 50)}...`);
    return;
  }
  
  if (data.isStreaming) {
    streamDidFire = true;
    if (!currentStreamEl) {
      removeTyping();
      const senderName = data.agentName || 'Society Agent';
      currentStreamEl = addMessage('assistant', '', senderName);
      streamText = '';
    }
    streamText += data.message;
    // Society Agent - Null check in case element was removed from DOM
    const contentEl = currentStreamEl?.querySelector('.content');
    if (contentEl) {
      contentEl.textContent = streamText;
    }
    scrollToBottom();
  } else if (data.isDone) {
    // Streaming complete - format the final message
    if (currentStreamEl && streamText) {
      const contentEl = currentStreamEl.querySelector('.content');
      if (contentEl) {
        contentEl.innerHTML = formatMarkdown(streamText);
      }
    }
    currentStreamEl = null;
    streamText = '';
    isStreaming = false;
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('stopBtn').style.display = 'none'; // Society Agent - hide stop
    removeTyping();
  }
});

// Purpose events
socket.on('purpose-started', (data) => {
  addLog('info', `Purpose started: ${data.description}`);
});

// Society Agent start - Stop agent function
function stopAgent() {
  if (!isStreaming) return;
  
  // Tell server to stop
  const agentId = selectedAgentId || 'default';
  socket.emit('stop-agent', { agentId });
  
  // Update UI immediately
  if (currentStreamEl) {
    streamText += '\n\n*[Stopped by user]*';
    const contentEl = currentStreamEl.querySelector('.content');
    if (contentEl) contentEl.innerHTML = formatMarkdown(streamText);
  }
  currentStreamEl = null;
  streamText = '';
  isStreaming = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('stopBtn').style.display = 'none';
  removeTyping();
  addLog('info', 'Agent stopped by user');
}
// Society Agent end

// Society Agent start - Show tool executions in chat so user sees what agent is doing
socket.on('tool-execution', (data) => {
  // Only show for selected agent (or if no agent selected, show all)
  if (selectedAgentId && data.agentId && data.agentId !== selectedAgentId) {
    addLog('info', `[${data.agentName || data.agentId}] ${data.details}`);
    return;
  }
  
  // Show tool execution as a progress message
  if (data.status === 'started') {
    const toolMsg = `\nüîß **${data.details}**\n`;
    if (currentStreamEl) {
      streamText += toolMsg;
      const contentEl = currentStreamEl.querySelector('.content');
      if (contentEl) contentEl.textContent = streamText;
      scrollToBottom();
    } else {
      // No stream active - show as system message
      addMessage('system', `üîß ${escapeHtml(data.details)}`);
    }
  }
});
// Society Agent end

socket.on('team-formed', (data) => {
  addLog('info', `Team formed: ${data.teamSize} agents`);
  loadProjects();
});

socket.on('progress-update', (data) => {
  addLog('info', `Progress: ${JSON.stringify(data.progress)}`);
});

socket.on('agent-status-change', (data) => {
  addLog('info', `Agent ${data.agentId}: ${data.status}`);
  loadProjects();
});

// File creation events
socket.on('file-created', (data) => {
  addLog('info', `File created: ${data.relativePath} (${formatSize(data.size)})`);
  addMessage('system', `&#128196; Created: ${data.relativePath} (${formatSize(data.size)})`);
  refreshFiles();
});

socket.on('file-deleted', (data) => {
  addLog('info', `Deleted: ${data.relativePath}${data.wasDir ? ' (directory)' : ''}`);
  refreshFiles();
});

// System events (multi-agent)
socket.on('system-event', (data) => {
  addLog(data.type.includes('error') ? 'error' : 'info', data.message || data.type);
  if (data.type === 'purpose-launching') {
    addMessage('system', data.message);
  }
  // Society Agent - handle system pause/resume events
  if (data.type === 'system-paused') {
    updatePauseUI(true, data.reason);
    addLog('warn', `System PAUSED: ${data.reason || 'Maintenance mode'}`);
  }
  if (data.type === 'system-resumed') {
    updatePauseUI(false);
    addLog('info', 'System RESUMED - accepting new work');
  }
});

// Society Agent start - System pause/resume management
let isSystemPaused = false;

function updatePauseUI(paused, reason = '') {
  isSystemPaused = paused;
  const banner = document.getElementById('pauseBanner');
  const btn = document.getElementById('pauseBtn');
  const btnIcon = document.getElementById('pauseBtnIcon');
  const btnText = document.getElementById('pauseBtnText');
  const reasonEl = document.getElementById('pauseReason');
  const statusDot = document.getElementById('statusDot');
  
  if (paused) {
    banner.classList.add('visible');
    btn.classList.add('paused');
    btnIcon.textContent = '‚ñ∂Ô∏è';
    btnText.textContent = 'Resume';
    if (reason) reasonEl.textContent = `(${reason})`;
    statusDot.classList.remove('online');
    statusDot.classList.add('paused');
  } else {
    banner.classList.remove('visible');
    btn.classList.remove('paused');
    btnIcon.textContent = '‚è∏';
    btnText.textContent = 'Maintenance';
    reasonEl.textContent = '';
    statusDot.classList.remove('paused');
    statusDot.classList.add('online');
  }
}

async function toggleSystemPause() {
  if (isSystemPaused) {
    await resumeSystem();
  } else {
    await pauseSystem();
  }
}

async function pauseSystem() {
  const reason = prompt('Enter reason for maintenance pause (optional):', 'Manual maintenance');
  if (reason === null) return; // cancelled
  
  try {
    const res = await fetch('/api/system/pause', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ reason: reason || 'Manual maintenance' })
    });
    const data = await res.json();
    if (data.success) {
      updatePauseUI(true, data.pausedState?.reason);
      addLog('warn', 'System paused for maintenance');
    } else {
      addLog('error', data.message || 'Failed to pause system');
    }
  } catch (e) {
    addLog('error', 'Failed to pause system: ' + e.message);
  }
}

async function resumeSystem() {
  try {
    const res = await fetch('/api/system/resume', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    if (data.success) {
      updatePauseUI(false);
      addLog('info', 'System resumed');
    } else {
      addLog('error', data.message || 'Failed to resume system');
    }
  } catch (e) {
    addLog('error', 'Failed to resume system: ' + e.message);
  }
}

async function checkSystemPauseState() {
  try {
    const res = await fetch('/api/system/state');
    if (res.ok) {
      const data = await res.json();
      updatePauseUI(data.systemPaused, data.pausedState?.reason);
    }
  } catch (e) {
    console.warn('Failed to check system pause state:', e);
  }
}
// Society Agent end - System pause/resume

// ============================================================================
// API Functions
// ============================================================================

async function checkServerStatus() {
  try {
    const res = await fetch(`${API}/api/status`);
    const data = await res.json();
    document.getElementById('sysStatus').textContent = data.status === 'ok' ? 'Online' : 'Error';
    if (data.outputDir) {
      const el = document.getElementById('outputDir');
      // Show short path, full path in tooltip
      const short = data.outputDir.replace(/^\/workspace\//, '');
      el.textContent = short;
      el.title = data.outputDir;
    }
    addLog('info', `Server: ${data.environment} | Output: ${data.outputDir || 'projects/'}`);
    refreshFiles();
  } catch (e) {
    document.getElementById('sysStatus').textContent = 'Error';
    addLog('error', 'Failed to reach server');
  }
}

async function checkApiKey() {
  try {
    const res = await fetch(`${API}/api/config/api-key`);
    const data = await res.json();
    const el = document.getElementById('apiKeyStatus');
    if (data.configured) {
      el.textContent = data.masked || 'Set';
      el.style.color = 'var(--green)';
    } else {
      el.textContent = 'Not set';
      el.style.color = 'var(--red)';
    }
  } catch (e) {
    addLog('error', 'Failed to check API key');
  }
}

async function sendMessage() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if ((!text && chatAttachments.length === 0) || isStreaming) return;

  // Hide welcome
  const welcome = document.getElementById('welcome');
  if (welcome) welcome.style.display = 'none';

  // Show user message with attachment previews
  let attachHtml = '';
  if (chatAttachments.length > 0) {
    attachHtml = '<div class="msg-attachments">' + chatAttachments.map(a => {
      if (a.type.startsWith('image/')) {
        return `<img src="${a.dataUrl}" title="${escapeHtml(a.name)}">`;
      }
      return `<span class="file-badge">&#128196; ${escapeHtml(a.name)}</span>`;
    }).join('') + '</div>';
  }
  const msgEl = addMessage('user', text);
  if (attachHtml) msgEl.querySelector('.content').innerHTML += attachHtml;

  // Build content array for API
  const contentParts = [];
  for (const a of chatAttachments) {
    if (a.type.startsWith('image/')) {
      contentParts.push({ type: 'image', source: { type: 'base64', media_type: a.mediaType, data: a.base64 } });
    } else {
      // Send text files as text content
      contentParts.push({ type: 'text', text: `[Attached file: ${a.name}]\n${atob(a.base64)}` });
    }
  }
  if (text) contentParts.push({ type: 'text', text: text });

  // Clear attachments
  chatAttachments = [];
  renderAttachChips();

  input.value = '';
  input.style.height = 'auto';
  messageCount++;
  document.getElementById('msgCount').textContent = messageCount;

  isStreaming = true;
  streamDidFire = false;
  document.getElementById('sendBtn').disabled = true;
  document.getElementById('stopBtn').style.display = 'inline-block'; // Society Agent - show stop
  showTyping();

  try {
    const agentId = selectedAgentId || undefined;
    const agentName = selectedAgentId ? (allProjectAgents.find(a => a.id === selectedAgentId)?.name || selectedAgentId) : undefined;

    const res = await fetch(`${API}/api/purpose/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        description: text,
        attachments: contentParts.length > 1 || contentParts[0]?.type === 'image' ? contentParts : undefined,
        agentId,
      }),
    });
    const data = await res.json();

    if (!res.ok) {
      removeTyping();
      addMessage('system', `Error: ${data.error || 'Unknown error'}`);
      isStreaming = false;
      document.getElementById('sendBtn').disabled = false;
      if (res.status === 401) showApiKeyModal();
      return;
    }

    // Only show HTTP response if WebSocket streaming didn't already handle it
    if (!streamDidFire && data.response) {
      removeTyping();
      const displayName = data.agentName || agentName || 'Society Agent';
      const el = addMessage('assistant', '', displayName);
      el.querySelector('.content').innerHTML = formatMarkdown(data.response);
      isStreaming = false;
      document.getElementById('sendBtn').disabled = false;
    }

    messageCount++;
    document.getElementById('msgCount').textContent = messageCount;
    addLog('info', `Response from ${data.agentName || agentName || 'Society Agent'} (history: ${data.historyLength} messages)`);
  } catch (e) {
    removeTyping();
    addMessage('system', `Network error: ${e.message}`);
    isStreaming = false;
    document.getElementById('sendBtn').disabled = false;
  }
}

async function saveApiKey() {
  const input = document.getElementById('apiKeyInput');
  const key = input.value.trim();
  if (!key) return;

  try {
    const res = await fetch(`${API}/api/config/api-key`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ apiKey: key }),
    });
    const data = await res.json();
    if (data.success) {
      hideApiKeyModal();
      checkApiKey();
      addLog('info', 'API key saved successfully');
    } else {
      alert(data.error || 'Failed to save');
    }
  } catch (e) {
    alert('Network error');
  }
}

async function refreshAgents() {
  try {
    const res = await fetch(`${API}/api/agents`);
    const data = await res.json();
    const list = document.getElementById('agentList');
    if (!data.agents || data.agents.length === 0) {
      list.innerHTML = '<div style="padding:16px;color:var(--muted);font-size:12px">No active agents</div>';
      return;
    }
    list.innerHTML = data.agents.map(a => `
      <div class="agent-card">
        <div class="name">${a.name || a.id}</div>
        <div class="role">${a.role}</div>
        <span class="status-badge ${a.status}">${a.status}</span>
      </div>
    `).join('');
  } catch (e) {}
}

// ============================================================================
// File Explorer - Tree with expand/collapse, drag-drop, context menu
// ============================================================================

let fileData = [];       // flat list from server
let expandedDirs = new Set(['']);  // track open folders ('' = root always open)
let selectedPath = null; // currently selected item
let dragSrc = null;      // path being dragged
let treeEventsDelegated = false; // Society Agent - track if delegated events attached

// Build nested tree from flat file list
function buildTree(files) {
  const root = { children: {}, path: '', isDir: true };
  for (const f of files) {
    const parts = f.path.split('/');
    let node = root;
    let pathSoFar = '';
    for (let i = 0; i < parts.length; i++) {
      pathSoFar = pathSoFar ? pathSoFar + '/' + parts[i] : parts[i];
      if (!node.children[parts[i]]) {
        node.children[parts[i]] = {
          name: parts[i], path: pathSoFar,
          isDir: i < parts.length - 1 || f.isDir,
          size: f.isDir ? 0 : f.size,
          children: {},
        };
      }
      node = node.children[parts[i]];
    }
    if (!f.isDir) { node.size = f.size; node.isDir = false; }
  }
  return root;
}

function fileIcon(name, isDir) {
  if (isDir) return '&#128193;';
  const ext = name.split('.').pop().toLowerCase();
  const icons = {
    js:'&#128312;', ts:'&#128309;', py:'&#128013;', html:'&#127760;', css:'&#127912;',
    json:'&#123;&#125;', md:'&#128221;', txt:'&#128196;', sh:'&#9000;', sql:'&#128451;',
    yaml:'&#9881;', yml:'&#9881;', xml:'&#128220;', csv:'&#128202;', log:'&#128203;',
    png:'&#127912;', jpg:'&#127912;', jpeg:'&#127912;', gif:'&#127912;', svg:'&#127912;',
    pdf:'&#128213;', zip:'&#128230;', tar:'&#128230;', gz:'&#128230;',
  };
  return icons[ext] || '&#128196;';
}

function renderTree(node, depth = 0) {
  const entries = Object.values(node.children);
  // Sort: dirs first, then alpha
  entries.sort((a, b) => {
    if (a.isDir !== b.isDir) return a.isDir ? -1 : 1;
    return a.name.localeCompare(b.name);
  });

  return entries.map(e => {
    const indent = depth * 16;
    const isOpen = expandedDirs.has(e.path);
    const sel = selectedPath === e.path ? ' selected' : '';

    if (e.isDir) {
      const hasKids = Object.keys(e.children).length > 0;
      const chevCls = hasKids ? (isOpen ? 'chevron open' : 'chevron') : 'chevron empty';
      let html = `<div class="tree-node" data-path="${escapeHtml(e.path)}" data-dir="true">
        <div class="tree-row dir-row${sel}" style="padding-left:${indent + 8}px"
             draggable="true" data-path="${escapeHtml(e.path)}" data-dir="true">
          <span class="${chevCls}">&#9654;</span>
          <span class="icon">${fileIcon(e.name, true)}</span>
          <span class="name">${escapeHtml(e.name)}</span>
          <span class="actions">
            <button class="act-btn" title="New file here" onclick="event.stopPropagation();promptNewFileInDir('${escapeAttr(e.path)}')">+&#128196;</button>
            <button class="act-btn" title="New folder here" onclick="event.stopPropagation();promptNewFolderInDir('${escapeAttr(e.path)}')">+&#128193;</button>
          </span>
        </div>
        <div class="tree-children ${isOpen ? '' : 'collapsed'}">
          ${hasKids ? renderTree(e, depth + 1) : ''}
        </div>
      </div>`;
      return html;
    } else {
      return `<div class="tree-node" data-path="${escapeHtml(e.path)}">
        <div class="tree-row${sel}" style="padding-left:${indent + 24}px"
             draggable="true" data-path="${escapeHtml(e.path)}" data-dir="false">
          <span class="icon">${fileIcon(e.name, false)}</span>
          <span class="name">${escapeHtml(e.name)}</span>
          <span class="size">${formatSize(e.size)}</span>
        </div>
      </div>`;
    }
  }).join('');
}

async function refreshFiles() {
  try {
    const res = await fetch(`${API}/api/workspace/files`);
    const data = await res.json();
    fileData = data.files || [];
    document.getElementById('fileCount').textContent = `${data.totalFiles} files, ${data.totalDirs} dirs`;

    const tree = document.getElementById('fileTree');
    if (fileData.length === 0) {
      tree.innerHTML = '<div style="padding:16px;color:var(--muted);font-size:12px">No files yet &mdash; ask the agent to create something</div>';
      return;
    }

    renderTreeFromCache();
  } catch (e) {
    addLog('warn', 'Failed to refresh files');
  }
}

// Society Agent start - Render tree from cached data (no API call, instant)
function renderTreeFromCache() {
  const tree = document.getElementById('fileTree');
  if (!tree || fileData.length === 0) return;
  
  const root = buildTree(fileData);
  tree.innerHTML = renderTree(root);
  attachTreeHandlers();
}
// Society Agent end

// Society Agent start - Attach delegated event handlers (only once)
function attachDelegatedTreeEvents() {
  if (treeEventsDelegated) return;
  treeEventsDelegated = true;
  
  const tree = document.getElementById('fileTree');
  if (!tree) return;

  // Click handler (event delegation)
  tree.addEventListener('click', (e) => {
    const row = e.target.closest('.tree-row');
    if (!row) return;

    const nodePath = row.dataset.path;
    const isDir = row.dataset.dir === 'true';

    // Toggle folder expand/collapse
    if (isDir) {
      if (expandedDirs.has(nodePath)) {
        expandedDirs.delete(nodePath);
      } else {
        expandedDirs.add(nodePath);
      }
      renderTreeFromCache();
      return;
    }

    // Select / view file
    selectedPath = nodePath;
    tree.querySelectorAll('.tree-row').forEach(r => r.classList.remove('selected'));
    row.classList.add('selected');

    if (!isDir) {
      viewFile(nodePath);
    }
  });

  // Double-click to rename
  tree.addEventListener('dblclick', (e) => {
    const row = e.target.closest('.tree-row');
    if (!row) return;
    e.preventDefault();
    startRename(row.dataset.path, row.dataset.dir === 'true');
  });

  // Right-click context menu
  tree.addEventListener('contextmenu', (e) => {
    const row = e.target.closest('.tree-row');
    if (!row) return;
    e.preventDefault();
    showContextMenu(e.clientX, e.clientY, row.dataset.path, row.dataset.dir === 'true');
  });
}
// Society Agent end

function attachTreeHandlers() {
  const tree = document.getElementById('fileTree');
  
  // Attach delegated events once
  attachDelegatedTreeEvents();

  // Drag-and-drop (must re-attach since rows are recreated)
  tree.querySelectorAll('.tree-row[draggable]').forEach(row => {
    row.addEventListener('dragstart', (e) => {
      dragSrc = row.dataset.path;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', row.dataset.path);
      // Custom ghost
      const ghost = document.createElement('div');
      ghost.className = 'drag-ghost';
      ghost.textContent = row.dataset.path.split('/').pop();
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, 0, 0);
      setTimeout(() => ghost.remove(), 0);
      row.style.opacity = '0.4';
    });

    row.addEventListener('dragend', () => {
      dragSrc = null;
      row.style.opacity = '';
      tree.querySelectorAll('.tree-row.drag-over').forEach(r => r.classList.remove('drag-over'));
    });

    // Only dirs receive drops
    if (row.dataset.dir === 'true') {
      row.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        row.classList.add('drag-over');
      });
      row.addEventListener('dragleave', () => {
        row.classList.remove('drag-over');
      });
      row.addEventListener('drop', async (e) => {
        e.preventDefault();
        row.classList.remove('drag-over');
        const from = e.dataTransfer.getData('text/plain');
        const toDir = row.dataset.path;
        if (!from || from === toDir) return;
        // Don't drop into self
        if (toDir.startsWith(from + '/')) return;
        const fileName = from.split('/').pop();
        const to = toDir + '/' + fileName;
        await moveFile(from, to);
      });
    }
  });

  // Also allow drop on root (file tree container) ‚Äî drop at root level
  tree.addEventListener('dragover', (e) => {
    if (e.target === tree) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }
  });
  tree.addEventListener('drop', async (e) => {
    if (e.target !== tree) return;
    e.preventDefault();
    const from = e.dataTransfer.getData('text/plain');
    if (!from) return;
    const fileName = from.split('/').pop();
    await moveFile(from, fileName);
  });

  // Also support file upload drag-drop onto folder rows
  tree.querySelectorAll('.tree-row[data-dir="true"]').forEach(row => {
    row.addEventListener('dragover', (e) => {
      // Check if it's an external file (not internal drag)
      if (e.dataTransfer.types.includes('Files')) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        row.classList.add('drag-over');
      }
    });
    row.addEventListener('drop', (e) => {
      row.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) {
        e.preventDefault();
        e.stopPropagation();
        uploadFiles(e.dataTransfer.files, row.dataset.path);
      }
    });
  });
}

// ============================================================================
// Context Menu
// ============================================================================

function showContextMenu(x, y, filePath, isDir) {
  hideContextMenu();
  selectedPath = filePath;

  const menu = document.createElement('div');
  menu.className = 'ctx-menu';
  menu.id = 'ctxMenu';

  const items = [];
  if (isDir) {
    items.push({ label: '&#128196;+ New File', action: () => promptNewFileInDir(filePath) });
    items.push({ label: '&#128193;+ New Folder', action: () => promptNewFolderInDir(filePath) });
    items.push({ type: 'sep' });
    items.push({ label: '&#128228; Upload Here', action: () => uploadToDir(filePath) });
    items.push({ type: 'sep' });
  } else {
    items.push({ label: '&#128065; View', action: () => viewFile(filePath) });
    if (isEditableFile(filePath)) {
      items.push({ label: '&#9998; Edit', action: () => editFile(filePath) });
    }
    items.push({ type: 'sep' });
  }
  items.push({ label: '&#9998; Rename', action: () => startRename(filePath, isDir), shortcut: 'F2' });
  items.push({ type: 'sep' });
  items.push({ label: '&#128465; Delete', action: () => deleteFile(filePath, isDir), cls: 'danger', shortcut: 'Del' });

  menu.innerHTML = items.map(it => {
    if (it.type === 'sep') return '<div class="ctx-sep"></div>';
    return `<div class="ctx-item ${it.cls || ''}" data-idx="${items.indexOf(it)}">${it.label}${it.shortcut ? `<span class="shortcut">${it.shortcut}</span>` : ''}</div>`;
  }).join('');

  // Attach click handlers
  menu.querySelectorAll('.ctx-item').forEach(el => {
    const idx = parseInt(el.dataset.idx);
    el.addEventListener('click', () => { hideContextMenu(); items[idx].action(); });
  });

  // Position (keep on screen)
  document.body.appendChild(menu);
  const rect = menu.getBoundingClientRect();
  if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 8;
  if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 8;
  menu.style.left = x + 'px';
  menu.style.top = y + 'px';

  // Close on click outside
  setTimeout(() => {
    document.addEventListener('click', hideContextMenu, { once: true });
    document.addEventListener('contextmenu', hideContextMenu, { once: true });
  }, 0);
}

function hideContextMenu() {
  const m = document.getElementById('ctxMenu');
  if (m) m.remove();
}

// ============================================================================
// Rename (inline editing)
// ============================================================================

function startRename(filePath, isDir) {
  const tree = document.getElementById('fileTree');
  const row = tree.querySelector(`.tree-row[data-path="${CSS.escape(filePath)}"]`);
  if (!row) return;

  const nameSpan = row.querySelector('.name');
  const oldName = filePath.split('/').pop();
  const origHTML = nameSpan.innerHTML;

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'rename-input';
  input.value = oldName;
  nameSpan.innerHTML = '';
  nameSpan.appendChild(input);
  input.focus();
  // Select name without extension for files
  if (!isDir) {
    const dotIdx = oldName.lastIndexOf('.');
    input.setSelectionRange(0, dotIdx > 0 ? dotIdx : oldName.length);
  } else {
    input.select();
  }

  function finish(commit) {
    const newName = input.value.trim();
    nameSpan.innerHTML = origHTML;
    if (commit && newName && newName !== oldName) {
      const parentPath = filePath.includes('/') ? filePath.substring(0, filePath.lastIndexOf('/')) : '';
      const newPath = parentPath ? parentPath + '/' + newName : newName;
      moveFile(filePath, newPath);
    }
  }

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); finish(true); }
    if (e.key === 'Escape') { e.preventDefault(); finish(false); }
    e.stopPropagation();
  });
  input.addEventListener('blur', () => finish(true));
  input.addEventListener('click', (e) => e.stopPropagation());
}

// ============================================================================
// File Operations (move, delete, upload, create)
// ============================================================================

async function moveFile(from, to) {
  if (from === to) return;
  try {
    const res = await fetch(`${API}/api/workspace/move`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ from, to }),
    });
    const data = await res.json();
    if (data.success) {
      addLog('info', `Moved: ${from} ‚Üí ${to}`);
      refreshFiles();
    } else {
      addLog('error', `Move failed: ${data.error}`);
    }
  } catch (e) {
    addLog('error', `Move error: ${e.message}`);
  }
}

async function deleteFile(filePath, isDir) {
  const kind = isDir ? 'directory and all its contents' : 'file';
  if (!confirm(`Delete ${kind}?\n${filePath}`)) return;
  try {
    const res = await fetch(`${API}/api/workspace/file?path=${encodeURIComponent(filePath)}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      addLog('info', `Deleted: ${filePath}`);
      refreshFiles();
    } else {
      addLog('error', `Delete failed: ${data.error}`);
    }
  } catch (e) {
    addLog('error', `Delete error: ${e.message}`);
  }
}

async function uploadFiles(files, targetDir = '') {
  for (const file of files) {
    const filePath = targetDir ? `${targetDir}/${file.name}` : file.name;
    addLog('info', `Uploading: ${filePath} (${formatSize(file.size)})...`);
    try {
      const content = await readFileAsBase64(file);
      const res = await fetch(`${API}/api/workspace/file`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: filePath, content, encoding: 'base64' }),
      });
      const data = await res.json();
      if (data.success) addLog('info', `Uploaded: ${filePath} (${formatSize(data.size)})`);
      else addLog('error', `Upload failed: ${data.error}`);
    } catch (e) {
      addLog('error', `Upload error: ${e.message}`);
    }
  }
  refreshFiles();
}

function readFileAsBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function uploadToDir(dirPath) {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.multiple = true;
  inp.onchange = () => { if (inp.files.length) uploadFiles(inp.files, dirPath); };
  inp.click();
}

function handleFileSelect(event) {
  const files = event.target.files;
  if (files.length) uploadFiles(files);
  event.target.value = '';
}

// Upload area drag-drop
const uploadArea = document.getElementById('uploadArea');
['dragenter', 'dragover'].forEach(ev => {
  uploadArea.addEventListener(ev, (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
});
['dragleave', 'drop'].forEach(ev => {
  uploadArea.addEventListener(ev, (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
});
uploadArea.addEventListener('drop', (e) => {
  if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
});

// Prompt helpers
async function promptNewFileInTree() { promptNewFileInDir(''); }
async function promptNewFolderInTree() { promptNewFolderInDir(''); }

async function promptNewFileInDir(dirPath) {
  const name = prompt(`New file name${dirPath ? ' in ' + dirPath : ''}:`);
  if (!name) return;
  const fullPath = dirPath ? dirPath + '/' + name : name;
  try {
    const res = await fetch(`${API}/api/workspace/file`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: fullPath, content: '' }),
    });
    const data = await res.json();
    if (data.success) {
      addLog('info', `Created: ${fullPath}`);
      if (dirPath) expandedDirs.add(dirPath);
      refreshFiles();
    } else addLog('error', data.error);
  } catch (e) { addLog('error', `Error: ${e.message}`); }
}

async function promptNewFolderInDir(dirPath) {
  const name = prompt(`New folder name${dirPath ? ' in ' + dirPath : ''}:`);
  if (!name) return;
  const fullPath = dirPath ? dirPath + '/' + name : name;
  try {
    const res = await fetch(`${API}/api/workspace/dir`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: fullPath }),
    });
    const data = await res.json();
    if (data.success) {
      addLog('info', `Folder created: ${fullPath}`);
      if (dirPath) expandedDirs.add(dirPath);
      expandedDirs.add(fullPath);
      refreshFiles();
    } else addLog('error', data.error);
  } catch (e) { addLog('error', `Error: ${e.message}`); }
}

// ============================================================================
// File Viewer Overlay
// ============================================================================

// Society Agent start - Enhanced file viewer with PDF and Markdown support
let currentFileContent = ''; // Store for toggle between raw/rendered
let currentFilePath = '';
let isEditing = false;

const editableExts = ['js', 'ts', 'jsx', 'tsx', 'py', 'java', 'c', 'cpp', 'h', 'go', 'rs', 'rb', 'php',
                      'swift', 'kt', 'json', 'yaml', 'yml', 'xml', 'toml', 'ini', 'html', 'css', 'scss',
                      'less', 'txt', 'log', 'csv', 'sh', 'bash', 'sql', 'env', 'md', 'markdown', 'tex', 'bib'];

function isEditableFile(path) {
  const ext = (path.split('.').pop() || '').toLowerCase();
  return editableExts.includes(ext);
}

async function editFile(filePath) {
  console.log('[editFile] Opening for edit:', filePath);
  
  if (!filePath || !isEditableFile(filePath)) {
    addLog('error', 'Cannot edit this file type');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/workspace/file?path=${encodeURIComponent(filePath)}`);
    const data = await res.json();
    if (!res.ok) { addLog('error', data.error); return; }
    
    currentFileContent = data.content;
    currentFilePath = filePath;
    isEditing = true;
    
    let viewer = document.getElementById('fileViewer');
    if (!viewer) {
      viewer = document.createElement('div');
      viewer.id = 'fileViewer';
      viewer.className = 'file-viewer';
      viewer.onclick = (e) => { if (e.target === viewer) closeFileViewer(); };
      document.body.appendChild(viewer);
    }
    
    const saveBtn = `<button class="save-btn" onclick="saveFileEdit()" id="saveBtn" style="margin-right:8px;background:var(--accent);border:none;color:#fff;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">&#128190; Save</button>`;
    const cancelBtn = `<button class="cancel-btn" onclick="closeFileViewer()" id="cancelBtn" style="margin-right:8px;background:var(--surface);border:1px solid var(--border);color:var(--fg);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel</button>`;
    
    viewer.innerHTML = `<div class="file-viewer-panel" style="max-width:900px;height:80vh;">
      <div class="file-viewer-header">
        <span class="title">&#9998; Editing: ${escapeHtml(filePath)}</span>
        <span class="meta">${formatSize(data.size)}</span>
        ${saveBtn}${cancelBtn}
        <button class="close-btn" onclick="closeFileViewer()" title="Close">&times;</button>
      </div>
      <div class="file-viewer-body" id="fileViewerBody" style="padding:0;">
        <textarea id="editTextarea" style="width:100%;height:100%;box-sizing:border-box;resize:none;border:none;font-family:'Monaco','Menlo','Consolas',monospace;font-size:13px;line-height:1.5;background:var(--surface);color:var(--fg);padding:16px;outline:none;">${escapeHtml(data.content)}</textarea>
      </div>
    </div>`;
    viewer.style.display = 'flex';
    
    const ta = document.getElementById('editTextarea');
    ta.focus();
    ta.setSelectionRange(0, 0);
  } catch (e) {
    addLog('error', 'Failed to open file for edit: ' + e.message);
  }
}

async function viewFile(filePath) {
  console.log('[viewFile] Opening:', filePath); // Debug log
  
  // Validation: ensure path is not empty
  if (!filePath) {
    addLog('error', 'Cannot view file: empty path');
    return;
  }
  
  try {
    const ext = filePath.split('.').pop().toLowerCase();
    const isPdf = ext === 'pdf';
    const isMd = ext === 'md' || ext === 'markdown';
    const isImage = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext);
    
    let viewer = document.getElementById('fileViewer');
    if (!viewer) {
      viewer = document.createElement('div');
      viewer.id = 'fileViewer';
      viewer.className = 'file-viewer';
      viewer.onclick = (e) => { if (e.target === viewer) closeFileViewer(); };
      document.body.appendChild(viewer);
    }

    // PDF: Use iframe (browsers have built-in PDF viewers)
    if (isPdf) {
      viewer.innerHTML = `<div class="file-viewer-panel pdf-viewer">
        <div class="file-viewer-header">
          <span class="title">&#128213; ${escapeHtml(filePath)}</span>
          <a href="${API}/api/workspace/raw?path=${encodeURIComponent(filePath)}" 
             download="${escapeAttr(filePath.split('/').pop())}" 
             style="color:var(--accent);font-size:12px;text-decoration:none;margin-right:8px;">‚¨á Download</a>
          <button class="close-btn" onclick="closeFileViewer()" title="Close">&times;</button>
        </div>
        <div class="file-viewer-body pdf-body">
          <iframe src="${API}/api/workspace/raw?path=${encodeURIComponent(filePath)}"></iframe>
        </div>
      </div>`;
      viewer.style.display = 'flex';
      return;
    }

    // Image: Display inline
    if (isImage) {
      viewer.innerHTML = `<div class="file-viewer-panel">
        <div class="file-viewer-header">
          <span class="title">&#127912; ${escapeHtml(filePath)}</span>
          <a href="${API}/api/workspace/raw?path=${encodeURIComponent(filePath)}" 
             download="${escapeAttr(filePath.split('/').pop())}" 
             style="color:var(--accent);font-size:12px;text-decoration:none;margin-right:8px;">‚¨á Download</a>
          <button class="close-btn" onclick="closeFileViewer()" title="Close">&times;</button>
        </div>
        <div class="file-viewer-body" style="text-align:center;">
          <img src="${API}/api/workspace/raw?path=${encodeURIComponent(filePath)}" 
               style="max-width:100%;max-height:70vh;border-radius:8px;" alt="${escapeAttr(filePath)}">
        </div>
      </div>`;
      viewer.style.display = 'flex';
      return;
    }

    // Text files: Fetch content
    const res = await fetch(`${API}/api/workspace/file?path=${encodeURIComponent(filePath)}`);
    const data = await res.json();
    if (!res.ok) { addLog('error', data.error); return; }
    
    currentFileContent = data.content;
    currentFilePath = filePath;

    // Markdown: Show rendered with toggle to raw
    if (isMd) {
      const rendered = renderMarkdown(data.content);
      const editBtn = `<button class="edit-btn" onclick="toggleEditMode()" id="editBtn" style="margin-right:8px;background:var(--surface);border:1px solid var(--border);color:var(--fg);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">&#9998; Edit</button>`;
      const saveBtn = `<button class="save-btn" onclick="saveFileEdit()" id="saveBtn" style="display:none;margin-right:8px;background:var(--accent);border:none;color:#fff;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">&#128190; Save</button>`;
      const cancelBtn = `<button class="cancel-btn" onclick="cancelEdit()" id="cancelBtn" style="display:none;margin-right:8px;background:var(--surface);border:1px solid var(--border);color:var(--fg);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel</button>`;
      
      viewer.innerHTML = `<div class="file-viewer-panel">
        <div class="file-viewer-header">
          <span class="title">&#128221; ${escapeHtml(filePath)}</span>
          <span class="meta">${formatSize(data.size)}</span>
          <div class="view-toggle" id="viewToggle">
            <button id="btnRendered" class="active" onclick="toggleMdView('rendered')">Rendered</button>
            <button id="btnRaw" onclick="toggleMdView('raw')">Raw</button>
          </div>
          ${editBtn}${saveBtn}${cancelBtn}
          <button class="close-btn" onclick="closeFileViewer()" title="Close">&times;</button>
        </div>
        <div class="file-viewer-body" id="fileViewerBody">
          <div class="markdown-body">${rendered}</div>
        </div>
      </div>`;
      viewer.style.display = 'flex';
      return;
    }

    // Default: Code/text view
    const editBtn = isEditableFile(filePath) ? 
      `<button class="edit-btn" onclick="toggleEditMode()" id="editBtn" style="margin-right:8px;background:var(--surface);border:1px solid var(--border);color:var(--fg);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">&#9998; Edit</button>` : '';
    const saveBtn = `<button class="save-btn" onclick="saveFileEdit()" id="saveBtn" style="display:none;margin-right:8px;background:var(--accent);border:none;color:#fff;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">&#128190; Save</button>`;
    const cancelBtn = `<button class="cancel-btn" onclick="cancelEdit()" id="cancelBtn" style="display:none;margin-right:8px;background:var(--surface);border:1px solid var(--border);color:var(--fg);padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;">Cancel</button>`;
    
    viewer.innerHTML = `<div class="file-viewer-panel">
      <div class="file-viewer-header">
        <span class="title">&#128196; ${escapeHtml(filePath)}</span>
        <span class="meta">${formatSize(data.size)}</span>
        ${editBtn}${saveBtn}${cancelBtn}
        <button class="close-btn" onclick="closeFileViewer()" title="Close">&times;</button>
      </div>
      <div class="file-viewer-body" id="fileViewerBody"><pre>${escapeHtml(data.content)}</pre></div>
    </div>`;
    viewer.style.display = 'flex';
  } catch (e) { addLog('error', 'Failed to read file: ' + e.message); }
}

function toggleEditMode() {
  isEditing = true;
  const body = document.getElementById('fileViewerBody');
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const viewToggle = document.getElementById('viewToggle');
  
  if (editBtn) editBtn.style.display = 'none';
  if (saveBtn) saveBtn.style.display = 'inline-block';
  if (cancelBtn) cancelBtn.style.display = 'inline-block';
  if (viewToggle) viewToggle.style.display = 'none';
  
  body.innerHTML = `<textarea id="editTextarea" style="width:100%;height:100%;box-sizing:border-box;resize:none;border:none;font-family:'Monaco','Menlo','Consolas',monospace;font-size:13px;line-height:1.5;background:var(--surface);color:var(--fg);padding:16px;outline:none;">${escapeHtml(currentFileContent)}</textarea>`;
  const ta = document.getElementById('editTextarea');
  ta.focus();
  ta.setSelectionRange(0, 0);
}

function cancelEdit() {
  isEditing = false;
  const body = document.getElementById('fileViewerBody');
  const editBtn = document.getElementById('editBtn');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const viewToggle = document.getElementById('viewToggle');
  const isMd = currentFilePath && ['md', 'markdown'].includes(currentFilePath.split('.').pop().toLowerCase());
  
  if (editBtn) editBtn.style.display = 'inline-block';
  if (saveBtn) saveBtn.style.display = 'none';
  if (cancelBtn) cancelBtn.style.display = 'none';
  if (viewToggle) viewToggle.style.display = 'flex';
  
  if (isMd) {
    body.innerHTML = `<div class="markdown-body">${renderMarkdown(currentFileContent)}</div>`;
  } else {
    body.innerHTML = `<pre>${escapeHtml(currentFileContent)}</pre>`;
  }
}

async function saveFileEdit() {
  const ta = document.getElementById('editTextarea');
  if (!ta || !currentFilePath) return;
  
  const content = ta.value;
  const saveBtn = document.getElementById('saveBtn');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = 'Saving...';
  }
  
  try {
    const res = await fetch(`${API}/api/workspace/file`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path: currentFilePath, content })
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to save');
    }
    
    currentFileContent = content;
    isEditing = false;
    
    const body = document.getElementById('fileViewerBody');
    const editBtn = document.getElementById('editBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const viewToggle = document.getElementById('viewToggle');
    const isMd = currentFilePath && ['md', 'markdown'].includes(currentFilePath.split('.').pop().toLowerCase());
    
    if (editBtn) editBtn.style.display = 'inline-block';
    if (saveBtn) saveBtn.style.display = 'none';
    if (cancelBtn) cancelBtn.style.display = 'none';
    if (viewToggle) viewToggle.style.display = 'flex';
    
    if (isMd) {
      body.innerHTML = `<div class="markdown-body">${renderMarkdown(content)}</div>`;
    } else {
      body.innerHTML = `<pre>${escapeHtml(content)}</pre>`;
    }
    
    addLog('info', `Saved: ${currentFilePath}`);
    refreshFiles();
  } catch (e) {
    alert('Error saving file: ' + e.message);
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '&#128190; Save';
    }
  }
}

function toggleMdView(mode) {
  const body = document.getElementById('fileViewerBody');
  const btnRendered = document.getElementById('btnRendered');
  const btnRaw = document.getElementById('btnRaw');
  if (!body) return;
  
  if (mode === 'raw') {
    body.innerHTML = `<pre>${escapeHtml(currentFileContent)}</pre>`;
    btnRendered.classList.remove('active');
    btnRaw.classList.add('active');
  } else {
    body.innerHTML = `<div class="markdown-body">${renderMarkdown(currentFileContent)}</div>`;
    btnRendered.classList.add('active');
    btnRaw.classList.remove('active');
  }
}

// Simple markdown renderer (no external dependencies)
function renderMarkdown(text) {
  if (!text) return '';
  let html = escapeHtml(text);
  
  // Code blocks (``` ... ```)
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code class="lang-$1">$2</code></pre>');
  
  // Inline code (`code`)
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  
  // Headers (# to ######)
  html = html.replace(/^###### (.+)$/gm, '<h6>$1</h6>');
  html = html.replace(/^##### (.+)$/gm, '<h5>$1</h5>');
  html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  
  // Bold (**text** or __text__)
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
  
  // Italic (*text* or _text_)
  html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
  
  // Strikethrough (~~text~~)
  html = html.replace(/~~(.+?)~~/g, '<del>$1</del>');
  
  // Blockquotes (> text)
  html = html.replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>');
  
  // Horizontal rules (---, ***, ___)
  html = html.replace(/^(---+|\*\*\*+|___+)$/gm, '<hr>');
  
  // Links [text](url)
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
  
  // Images ![alt](url)
  html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;">');
  
  // Unordered lists (- item or * item)
  html = html.replace(/^[\-\*] (.+)$/gm, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>\n)+/g, '<ul>$&</ul>');
  
  // Ordered lists (1. item)
  html = html.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
  
  // Tables (basic support)
  html = html.replace(/^\|(.+)\|$/gm, (match, content) => {
    const cells = content.split('|').map(c => c.trim());
    if (cells.every(c => /^[-:]+$/.test(c))) return ''; // separator row
    const isHeader = content.includes('---');
    const tag = isHeader ? 'th' : 'td';
    return '<tr>' + cells.map(c => `<${tag}>${c}</${tag}>`).join('') + '</tr>';
  });
  html = html.replace(/(<tr>.*<\/tr>\n?)+/g, '<table>$&</table>');
  
  // Paragraphs (double newlines)
  html = html.replace(/\n\n+/g, '</p><p>');
  html = '<p>' + html + '</p>';
  
  // Clean up empty paragraphs and fix nesting
  html = html.replace(/<p><\/p>/g, '');
  html = html.replace(/<p>(<h[1-6]>)/g, '$1');
  html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
  html = html.replace(/<p>(<pre>)/g, '$1');
  html = html.replace(/(<\/pre>)<\/p>/g, '$1');
  html = html.replace(/<p>(<ul>)/g, '$1');
  html = html.replace(/(<\/ul>)<\/p>/g, '$1');
  html = html.replace(/<p>(<table>)/g, '$1');
  html = html.replace(/(<\/table>)<\/p>/g, '$1');
  html = html.replace(/<p>(<blockquote>)/g, '$1');
  html = html.replace(/(<\/blockquote>)<\/p>/g, '$1');
  html = html.replace(/<p>(<hr>)/g, '$1');
  html = html.replace(/(<hr>)<\/p>/g, '$1');
  
  return html;
}
// Society Agent end

function closeFileViewer() {
  const v = document.getElementById('fileViewer');
  if (v) v.style.display = 'none';
}

function formatSize(bytes) {
  if (!bytes || bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function escapeAttr(s) {
  return s.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

// ============================================================================
// Sidebar Resize Handle
// ============================================================================

(function initSidebarResize() {
  const sidebar = document.getElementById('sidebar');
  const handle = document.getElementById('sidebarResize');
  let startX, startWidth;

  handle.addEventListener('mousedown', (e) => {
    e.preventDefault();
    startX = e.clientX;
    startWidth = sidebar.offsetWidth;
    handle.classList.add('active');
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', onUp);
  });

  function onDrag(e) {
    const w = startWidth + (e.clientX - startX);
    sidebar.style.width = Math.max(180, Math.min(600, w)) + 'px';
  }

  function onUp() {
    handle.classList.remove('active');
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', onUp);
    // Persist sidebar width
    try { localStorage.setItem('sidebar-width', sidebar.style.width); } catch {}
  }

  // Restore saved width
  try {
    const saved = localStorage.getItem('sidebar-width');
    if (saved) sidebar.style.width = saved;
  } catch {}
})();

// Listen for file-moved events from server
socket.on('file-moved', () => refreshFiles());

// ============================================================================
// UI Helpers
// ============================================================================

function addMessage(role, content, sender) {
  const el = document.createElement('div');
  el.className = `message ${role}`;
  if (role === 'assistant') {
    el.innerHTML = `<div class="sender">${sender || 'Agent'}</div><div class="content">${formatMarkdown(content)}</div>`;
  } else {
    el.innerHTML = `<div class="content">${escapeHtml(content)}</div>`;
  }
  document.getElementById('messages').appendChild(el);
  scrollToBottom();
  return el;
}

function showTyping() {
  const el = document.createElement('div');
  el.className = 'typing';
  el.id = 'typingIndicator';
  el.textContent = 'Agent is thinking';
  document.getElementById('messages').appendChild(el);
  scrollToBottom();
}

function removeTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

function scrollToBottom() {
  const m = document.getElementById('messages');
  m.scrollTop = m.scrollHeight;
}

// Society Agent start - Enhanced status with reconnection message
function setStatus(online, statusMsg) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  const btn = document.getElementById('reconnectBtn');
  dot.className = `dot ${online ? 'online' : 'offline'}`;
  if (statusMsg) {
    text.textContent = statusMsg;
  } else {
    text.textContent = online ? 'Connected' : 'Disconnected';
  }
  // Show reconnect button when disconnected
  btn.style.display = online ? 'none' : 'inline-block';
}

function manualReconnect() {
  addLog('info', 'Manual reconnect requested...');
  setStatus(false, 'Reconnecting...');
  socket.disconnect();
  setTimeout(() => socket.connect(), 500);
}

// Society Agent - Clear all state and reload page
function clearAndReset() {
  if (!confirm('This will clear all local state and reload the page. Continue?')) return;
  
  // Clear localStorage
  try { localStorage.clear(); } catch {}
  
  // Clear sessionStorage
  try { sessionStorage.clear(); } catch {}
  
  // Disconnect socket cleanly
  try { socket.disconnect(); } catch {}
  
  // Clear any IndexedDB (if used)
  try {
    if (indexedDB && indexedDB.databases) {
      indexedDB.databases().then(dbs => {
        dbs.forEach(db => indexedDB.deleteDatabase(db.name));
      });
    }
  } catch {}
  
  // Force hard reload bypassing cache
  window.location.reload(true);
}
// Society Agent end

function addLog(level, text) {
  const el = document.createElement('div');
  el.className = `log-entry ${level}`;
  const ts = new Date().toLocaleTimeString();
  el.innerHTML = `<span class="ts">${ts}</span>${escapeHtml(text)}`;
  const panel = document.getElementById('logPanel');
  panel.appendChild(el);
  panel.scrollTop = panel.scrollHeight;
}

// ============================================================================
// Settings Modal (Provider/Model Configuration)
// ============================================================================

// Models available per provider with cost info ($/1M tokens)
const MODELS_BY_PROVIDER = {
  anthropic: [
    { id: 'claude-sonnet-4-20250514', name: 'Claude Sonnet 4 (Latest)', input: 3, output: 15 },
    { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', input: 3, output: 15 },
    { id: 'claude-3-opus-20240229', name: 'Claude 3 Opus', input: 15, output: 75 },
    { id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku (Fast)', input: 0.25, output: 1.25 },
  ],
  openrouter: [
    { id: 'anthropic/claude-sonnet-4', name: 'Claude Sonnet 4', input: 3, output: 15 },
    { id: 'anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', input: 3, output: 15 },
    { id: 'anthropic/claude-3-opus', name: 'Claude 3 Opus', input: 15, output: 75 },
    { id: 'anthropic/claude-3-haiku', name: 'Claude 3 Haiku', input: 0.25, output: 1.25 },
    { id: 'openai/gpt-4o', name: 'GPT-4o', input: 2.5, output: 10 },
    { id: 'openai/gpt-4o-mini', name: 'GPT-4o Mini (Fast)', input: 0.15, output: 0.60 },
    { id: 'google/gemini-2.0-flash-001', name: 'Gemini 2.0 Flash', input: 0.10, output: 0.40 },
    { id: 'google/gemini-pro', name: 'Gemini Pro', input: 0.125, output: 0.375 },
    { id: 'meta-llama/llama-3.1-70b-instruct', name: 'Llama 3.1 70B', input: 0.52, output: 0.75 },
    { id: 'meta-llama/llama-3.1-8b-instruct', name: 'Llama 3.1 8B (Fast)', input: 0.055, output: 0.055 },
    { id: 'deepseek/deepseek-chat', name: 'DeepSeek Chat', input: 0.14, output: 0.28 },
    { id: 'mistralai/mistral-large', name: 'Mistral Large', input: 2, output: 6 },
    { id: 'qwen/qwen-2.5-72b-instruct', name: 'Qwen 2.5 72B', input: 0.35, output: 0.40 },
    { id: 'minimax/minimax-m2.5', name: 'MiniMax M2.5', input: 0.30, output: 1.10 },
  ],
  openai: [
    { id: 'gpt-4o', name: 'GPT-4o', input: 2.5, output: 10 },
    { id: 'gpt-4o-mini', name: 'GPT-4o Mini (Fast)', input: 0.15, output: 0.60 },
    { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', input: 10, output: 30 },
    { id: 'o1-preview', name: 'o1 Preview (Reasoning)', input: 15, output: 60 },
    { id: 'o1-mini', name: 'o1 Mini', input: 3, output: 12 },
  ],
  gemini: [
    { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', input: 1.25, output: 5 },
    { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash (Fast)', input: 0.075, output: 0.30 },
    { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', input: 0.10, output: 0.40 },
  ],
  deepseek: [
    { id: 'deepseek-chat', name: 'DeepSeek Chat', input: 0.14, output: 0.28 },
    { id: 'deepseek-coder', name: 'DeepSeek Coder', input: 0.14, output: 0.28 },
  ],
  groq: [
    { id: 'llama-3.1-70b-versatile', name: 'Llama 3.1 70B', input: 0.59, output: 0.79 },
    { id: 'llama-3.1-8b-instant', name: 'Llama 3.1 8B (Fast)', input: 0.05, output: 0.08 },
    { id: 'mixtral-8x7b-32768', name: 'Mixtral 8x7B', input: 0.24, output: 0.24 },
  ],
  mistral: [
    { id: 'mistral-large-latest', name: 'Mistral Large', input: 2, output: 6 },
    { id: 'mistral-medium-latest', name: 'Mistral Medium', input: 2.7, output: 8.1 },
    { id: 'mistral-small-latest', name: 'Mistral Small', input: 0.2, output: 0.6 },
  ],
};

const API_KEY_LABELS = {
  anthropic: 'Anthropic API Key',
  openrouter: 'OpenRouter API Key',
  openai: 'OpenAI API Key',
  gemini: 'Google AI API Key',
  deepseek: 'DeepSeek API Key',
  groq: 'Groq API Key',
  mistral: 'Mistral API Key',
};

const API_KEY_PLACEHOLDERS = {
  anthropic: 'sk-ant-api03-...',
  openrouter: 'sk-or-v1-...',
  openai: 'sk-...',
  gemini: 'AIza...',
  deepseek: 'sk-...',
  groq: 'gsk_...',
  mistral: '...',
};

let currentSettings = null;

async function showApiKeyModal() {
  // Load current settings from server
  try {
    const res = await fetch(`${API}/api/config/provider`);
    const data = await res.json();
    currentSettings = data;
    
    // Set provider dropdown
    const providerSelect = document.getElementById('settingsProvider');
    providerSelect.value = data.provider || 'anthropic';
    
    // Populate model dropdown
    onProviderChange();
    
    // Set current model
    if (data.model) {
      document.getElementById('settingsModel').value = data.model;
      updateModelCost();
    }
    
    // Show API key status
    const statusEl = document.getElementById('settingsApiKeyStatus');
    if (data.apiKeyConfigured) {
      statusEl.textContent = '‚úì API key configured';
      statusEl.style.color = 'var(--success)';
      document.getElementById('settingsApiKey').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
    } else {
      statusEl.textContent = '‚úó No API key configured';
      statusEl.style.color = 'var(--error)';
    }
    
    // Load advanced settings
    const fullSettings = await fetch(`${API}/api/settings`).then(r => r.json()).catch(() => ({}));
    if (fullSettings.defaultMaxTokens) {
      document.getElementById('settingsMaxTokens').value = fullSettings.defaultMaxTokens;
    }
    if (fullSettings.defaultTemperature !== undefined) {
      document.getElementById('settingsTemperature').value = fullSettings.defaultTemperature;
    }
  } catch (e) {
    console.error('Failed to load settings:', e);
  }
  
  document.getElementById('apiKeyModal').style.display = 'flex';
}

function hideApiKeyModal() { 
  document.getElementById('apiKeyModal').style.display = 'none'; 
}

function onProviderChange() {
  const provider = document.getElementById('settingsProvider').value;
  const modelSelect = document.getElementById('settingsModel');
  const models = MODELS_BY_PROVIDER[provider] || [];
  
  modelSelect.innerHTML = models.map(m => 
    `<option value="${m.id}">${m.name}</option>`
  ).join('');
  
  // Update API key label and placeholder
  document.getElementById('settingsApiKeyLabel').textContent = API_KEY_LABELS[provider] || 'API Key';
  document.getElementById('settingsApiKey').placeholder = API_KEY_PLACEHOLDERS[provider] || 'sk-...';
  
  // Clear API key field (different provider needs different key)
  document.getElementById('settingsApiKey').value = '';
  document.getElementById('settingsApiKeyStatus').textContent = 'Enter API key for ' + provider;
  document.getElementById('settingsApiKeyStatus').style.color = 'var(--muted)';
  
  updateModelCost();
}

function updateModelCost() {
  const provider = document.getElementById('settingsProvider').value;
  const modelId = document.getElementById('settingsModel').value;
  const models = MODELS_BY_PROVIDER[provider] || [];
  const model = models.find(m => m.id === modelId);
  
  const costEl = document.getElementById('settingsModelCost');
  if (model) {
    costEl.textContent = `Cost: $${model.input}/1M input, $${model.output}/1M output`;
  } else {
    costEl.textContent = '';
  }
}

// Add change handler for model dropdown
document.addEventListener('DOMContentLoaded', () => {
  const modelSelect = document.getElementById('settingsModel');
  if (modelSelect) {
    modelSelect.addEventListener('change', updateModelCost);
  }
});

async function saveSettings() {
  const provider = document.getElementById('settingsProvider').value;
  const model = document.getElementById('settingsModel').value;
  const apiKey = document.getElementById('settingsApiKey').value.trim();
  const maxTokens = parseInt(document.getElementById('settingsMaxTokens').value) || 16384;
  const temperature = parseFloat(document.getElementById('settingsTemperature').value) || 0.7;
  
  // Validate
  if (!apiKey && !currentSettings?.apiKeyConfigured) {
    alert('Please enter an API key');
    return;
  }
  
  try {
    // Save provider config (with or without new API key)
    const providerPayload = {
      apiProvider: provider,
      apiModelId: model,
      maxTokens,
      temperature,
    };
    
    // Add appropriate API key field based on provider
    if (apiKey) {
      if (provider === 'anthropic') providerPayload.anthropicApiKey = apiKey;
      else if (provider === 'openrouter') providerPayload.openRouterApiKey = apiKey;
      else if (provider === 'openai') providerPayload.openAiApiKey = apiKey;
      else if (provider === 'gemini') providerPayload.geminiApiKey = apiKey;
      else providerPayload.apiKey = apiKey;
    }
    
    const res = await fetch(`${API}/api/config/provider`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(providerPayload),
    });
    
    const data = await res.json();
    
    if (data.success) {
      hideApiKeyModal();
      addLog('info', `Settings saved: ${provider} / ${model}`);
      
      // Update status bar to show new provider/model
      updateProviderStatus(provider, model);
      
      // Reload to pick up new settings
      checkApiKey();
    } else {
      alert(data.error || 'Failed to save settings');
    }
  } catch (e) {
    console.error('Save settings error:', e);
    alert('Network error saving settings');
  }
}

// Update the status bar to show current provider/model
function updateProviderStatus(provider, model) {
  // Add or update provider badge in header
  let badge = document.getElementById('providerBadge');
  if (!badge) {
    badge = document.createElement('span');
    badge.id = 'providerBadge';
    badge.style.cssText = 'font-size:11px;color:var(--muted);margin-left:8px;background:var(--bg-lighter);padding:2px 6px;border-radius:4px;';
    const settingsBtn = document.querySelector('button[onclick="showApiKeyModal()"]');
    if (settingsBtn) settingsBtn.parentNode.insertBefore(badge, settingsBtn);
  }
  
  // Format model name nicely
  const shortModel = model.split('/').pop().replace(/-\d{8}$/, '');
  badge.textContent = `${provider}: ${shortModel}`;
}

// Load initial provider status
async function loadProviderStatus() {
  try {
    const res = await fetch(`${API}/api/config/provider`);
    const data = await res.json();
    if (data.provider && data.model) {
      updateProviderStatus(data.provider, data.model);
    }
  } catch (e) {
    console.error('Failed to load provider status:', e);
  }
}

// Call on page load
document.addEventListener('DOMContentLoaded', loadProviderStatus);

// Legacy saveApiKey function (for backward compatibility)
async function saveApiKey() {
  return saveSettings();
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

function formatMarkdown(text) {
  if (!text) return '';
  let html = escapeHtml(text);
  // Code blocks
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Bold
  html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
  // Italic
  html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
  // Line breaks
  html = html.replace(/\n/g, '<br>');
  return html;
}

// ============================================================================
// Chat Attachments
// ============================================================================

function handleChatAttach(event) {
  const files = event.target.files;
  for (const file of files) {
    if (file.type.startsWith('image/')) {
      // Resize images to avoid token limit (max 1024px on longest side)
      // resizeImage converts to JPEG, so mediaType must be image/jpeg
      resizeImage(file, 1024).then(({ dataUrl, base64 }) => {
        chatAttachments.push({
          name: file.name,
          type: file.type,
          dataUrl,
          base64,
          mediaType: 'image/jpeg',
        });
        renderAttachChips();
      });
    } else {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const base64 = dataUrl.split(',')[1];
        chatAttachments.push({
          name: file.name,
          type: file.type || 'application/octet-stream',
          dataUrl,
          base64,
          mediaType: file.type || 'application/octet-stream',
        });
        renderAttachChips();
      };
      reader.readAsDataURL(file);
    }
  }
  event.target.value = '';
}

// Resize image to fit within maxPx on the longest side, returns JPEG base64
function resizeImage(file, maxPx) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      let { width, height } = img;
      if (width > maxPx || height > maxPx) {
        const scale = maxPx / Math.max(width, height);
        width = Math.round(width * scale);
        height = Math.round(height * scale);
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      // Use JPEG at 85% quality for smaller size
      const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
      const base64 = dataUrl.split(',')[1];
      resolve({ dataUrl, base64 });
      URL.revokeObjectURL(img.src);
    };
    img.src = URL.createObjectURL(file);
  });
}

function renderAttachChips() {
  const container = document.getElementById('attachChips');
  if (chatAttachments.length === 0) {
    container.style.display = 'none';
    container.innerHTML = '';
    return;
  }
  container.style.display = 'flex';
  container.innerHTML = chatAttachments.map((a, i) => {
    const preview = a.type.startsWith('image/')
      ? `<img src="${a.dataUrl}" alt="${escapeHtml(a.name)}">`
      : '&#128196;';
    return `<span class="attach-chip">${preview} ${escapeHtml(a.name)}<span class="remove" onclick="removeAttachment(${i})">&#10005;</span></span>`;
  }).join('');
}

function removeAttachment(index) {
  chatAttachments.splice(index, 1);
  renderAttachChips();
}

// Also support drag-drop onto the chat input area
document.querySelector('.input-area').addEventListener('dragover', (e) => e.preventDefault());
document.querySelector('.input-area').addEventListener('drop', (e) => {
  e.preventDefault();
  if (e.dataTransfer.files.length) {
    const fakeEvent = { target: { files: e.dataTransfer.files, value: '' } };
    handleChatAttach(fakeEvent);
  }
});

// Society Agent start - Paste images from clipboard
document.getElementById('input').addEventListener('paste', async (e) => {
  const items = e.clipboardData?.items;
  if (!items) return;
  
  for (const item of items) {
    if (item.type.startsWith('image/')) {
      e.preventDefault();
      const file = item.getAsFile();
      if (file) {
        // Generate a name for pasted images
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
        const ext = file.type.split('/')[1] || 'png';
        const name = `pasted-image-${timestamp}.${ext}`;
        
        // Create a new file with the generated name
        const namedFile = new File([file], name, { type: file.type });
        
        const { dataUrl, base64 } = await resizeImage(namedFile, 1024);
        // resizeImage converts to JPEG, so mediaType must be image/jpeg
        chatAttachments.push({ 
          name: name, 
          type: file.type, 
          dataUrl, 
          base64, 
          mediaType: 'image/jpeg' 
        });
        renderAttachChips();
        addLog('info', `Pasted image: ${name}`);
      }
    }
  }
});
// Society Agent end

// ============================================================================
// Keyboard
// ============================================================================

document.getElementById('input').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Close file viewer with Escape; F2 to rename; Delete to delete
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') { closeFileViewer(); hideContextMenu(); }
  // F2 to rename selected file
  if (e.key === 'F2' && selectedPath) {
    e.preventDefault();
    const isDir = fileData.some(f => f.path === selectedPath && f.isDir);
    startRename(selectedPath, isDir);
  }
  // Delete key to delete selected file
  if (e.key === 'Delete' && selectedPath && !document.querySelector('.rename-input')) {
    e.preventDefault();
    const isDir = fileData.some(f => f.path === selectedPath && f.isDir);
    deleteFile(selectedPath, isDir);
  }
});

// Auto-resize textarea
document.getElementById('input').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 200) + 'px';
});

// ============================================================================
// Project Management
// ============================================================================

let projects = [];
let allProjectAgents = []; // flattened list of all agents across projects
let selectedAgentId = ''; // '' means default society agent
let editingProjectId = null; // null = create, string = editing

async function loadProjects() {
  try {
    const res = await fetch(`${API}/api/projects`);
    const data = await res.json();
    projects = data.projects || [];
    // Flatten agents for the selector
    allProjectAgents = [];
    projects.forEach(p => {
      (p.agents || []).forEach(a => {
        allProjectAgents.push({ ...a, projectId: p.id, projectName: p.name });
      });
    });
    renderAgentSelector();
    renderProjectsGrid();
    renderSidebarProjects();
  } catch (e) {
    addLog('warn', 'Failed to load projects');
  }
}

// ============================================================================
// Skills & MCPs
// ============================================================================

async function refreshSkills() {
  const list = document.getElementById('skillsList');
  if (!list) return;
  list.innerHTML = '<div class="skill-item" style="color:#8b949e;">Loading...</div>';
  try {
    const res = await fetch(`${API}/api/skills`);
    const data = await res.json();
    if (data.skills && data.skills.length > 0) {
      list.innerHTML = data.skills.map(s => `
        <div class="skill-item" style="padding:8px 0;border-bottom:1px solid #21262d;">
          <div style="font-weight:500;color:#e6edf3;">${escapeHtml(s.name)}</div>
          <div style="font-size:12px;color:#8b949e;margin-top:2px;">${escapeHtml(s.description || 'No description')}</div>
          ${s.version ? `<div style="font-size:11px;color:#6e7681;margin-top:2px;">v${escapeHtml(s.version)}</div>` : ''}
        </div>
      `).join('');
    } else {
      list.innerHTML = '<div style="color:#8b949e;font-size:13px;">No global skills installed.<br><span style="font-size:12px;">Add .js files to /skills/ folder</span></div>';
    }
  } catch (e) {
    list.innerHTML = '<div style="color:#f85149;">Error loading skills</div>';
  }
}

async function refreshMcps() {
  const list = document.getElementById('mcpsList');
  if (!list) return;
  list.innerHTML = '<div class="mcp-item" style="color:#8b949e;">Loading...</div>';
  try {
    const res = await fetch(`${API}/api/mcps`);
    const data = await res.json();
    if (data.mcps && data.mcps.length > 0) {
      list.innerHTML = data.mcps.map(m => `
        <div class="mcp-item" style="padding:8px 0;border-bottom:1px solid #21262d;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="color:${m.enabled ? '#3fb950' : '#8b949e'};">‚óè</span>
            <span style="font-weight:500;color:#e6edf3;flex:1;">${escapeHtml(m.name)}</span>
            <button onclick="toggleGlobalMcp('${escapeHtml(m.name)}')" 
              style="background:${m.enabled ? 'rgba(248,81,73,0.15)' : 'rgba(63,185,80,0.15)'};
                     color:${m.enabled ? '#f85149' : '#3fb950'};
                     border:1px solid ${m.enabled ? 'rgba(248,81,73,0.3)' : 'rgba(63,185,80,0.3)'};
                     border-radius:4px;padding:2px 8px;font-size:10px;cursor:pointer;">
              ${m.enabled ? 'Disable' : 'Enable'}
            </button>
          </div>
          <div style="font-size:12px;color:#8b949e;margin-top:4px;margin-left:16px;">${escapeHtml(m.description || 'No description')}</div>
          <div style="font-size:11px;color:#6e7681;margin-top:2px;margin-left:16px;font-family:monospace;">${escapeHtml(m.command)} ${(m.args || []).map(a => escapeHtml(a)).join(' ')}</div>
        </div>
      `).join('');
    } else {
      list.innerHTML = '<div style="color:#8b949e;font-size:13px;">No global MCPs configured.<br><span style="font-size:12px;">Add servers to /mcp-config.json</span></div>';
    }
  } catch (e) {
    list.innerHTML = '<div style="color:#f85149;">Error loading MCPs</div>';
  }
}

async function toggleGlobalMcp(name) {
  try {
    await fetch(`${API}/api/mcps/${encodeURIComponent(name)}/toggle`, { method: 'POST' });
    refreshMcps();
  } catch (e) {
    console.error('Failed to toggle MCP:', e);
  }
}

function renderAgentSelector() {
  const sel = document.getElementById('agentSelect');
  const prev = sel.value;
  let html = '<option value="">Default (Society Agent)</option>';
  projects.forEach(p => {
    if (!p.agents || p.agents.length === 0) return;
    html += `<optgroup label="${escapeHtml(p.name)}">`;
    p.agents.forEach(a => {
      html += `<option value="${escapeHtml(a.id)}" ${a.id === prev ? 'selected' : ''}>${escapeHtml(a.name)} ‚Äî ${escapeHtml(a.role)}</option>`;
    });
    html += '</optgroup>';
  });
  sel.innerHTML = html;
  // Restore selection
  if (prev && allProjectAgents.some(a => a.id === prev)) {
    sel.value = prev;
  }
  onAgentChange();
}

function onAgentChange() {
  const sel = document.getElementById('agentSelect');
  selectedAgentId = sel.value;
  const info = document.getElementById('agentSelectInfo');
  
  // Society Agent start - Clear chat when switching agents
  // Reset streaming state
  currentStreamEl = null;
  streamText = '';
  isStreaming = false;
  
  // Clear chat messages area (keep it simple - start fresh)
  const messages = document.getElementById('messages');
  messages.innerHTML = '';
  
  // Show which agent is selected
  if (selectedAgentId) {
    const agent = allProjectAgents.find(a => a.id === selectedAgentId);
    if (agent) {
      addMessage('system', `Now chatting with <b>${escapeHtml(agent.name)}</b> (${escapeHtml(agent.role)})`);
    }
  } else {
    addMessage('system', 'Select an agent from the dropdown above to start chatting');
  }
  // Society Agent end
  
  if (!selectedAgentId) {
    info.innerHTML = '';
    return;
  }
  const agent = allProjectAgents.find(a => a.id === selectedAgentId);
  if (agent) {
    info.innerHTML = `<span style="color:var(--muted);font-size:10px">${escapeHtml(agent.projectName)}</span> ¬∑ ${escapeHtml((agent.capabilities || []).slice(0, 3).join(', '))}`;
  }
}

function renderProjectsGrid() {
  const grid = document.getElementById('projectsGrid');
  const countEl = document.getElementById('projectCountInfo');
  countEl.textContent = `${projects.length} project${projects.length !== 1 ? 's' : ''}`;

  let html = projects.map(p => {
    const agentChips = (p.agents || []).map(a => {
      const dotCls = !a.ephemeral ? 'supervisor' : 'worker'; // Society Agent - Use !ephemeral
      return `<span class="project-agent-chip"><span class="chip-dot ${dotCls}"></span>${escapeHtml(a.name)}</span>`;
    }).join('');

    const totalMsgs = (p.agents || []).reduce((sum, a) => sum + (a.totalMessages || 0), 0);
    const totalTasks = (p.agents || []).reduce((sum, a) => sum + (a.tasksCompleted || 0), 0);
    
    // Society Agent start - Git integration display
    const gitConfig = p.gitConfig;
    const isGitProject = !!gitConfig;
    const gitIcon = isGitProject ? '&#128268;' : '&#128193;';
    const gitBadge = isGitProject ? `<span class="git-badge" title="Branch: ${escapeAttr(gitConfig.currentRef || gitConfig.defaultRef)}" onclick="event.stopPropagation();showGitActions('${escapeAttr(p.id)}')">&#127796; ${escapeHtml(gitConfig.currentRef || gitConfig.defaultRef)}</span>` : '';
    // Society Agent end

    return `<div class="project-card">
      <div class="project-header">
        <div class="project-icon">${gitIcon}</div>
        <div class="project-meta">
          <div class="project-name">${escapeHtml(p.name)} ${gitBadge}</div>
          <div class="project-desc">${escapeHtml(p.description || '')}</div>
        </div>
        <span class="status-badge ${p.status === 'active' ? 'active' : 'idle'}">${p.status || 'active'}</span>
      </div>
      <div class="project-folder">&#128194; ${escapeHtml(p.folder || '/')}</div>
      <div class="project-agents">${agentChips || '<span style="color:var(--muted);font-size:11px">No agents</span>'}</div>
      <div class="project-stats">
        <span>&#129302; ${(p.agents || []).length} agent${(p.agents || []).length !== 1 ? 's' : ''}</span>
        <span>&#128172; ${totalMsgs} msgs</span>
        <span>&#9989; ${totalTasks} tasks</span>
      </div>
      <div class="project-actions">
        <button class="btn btn-primary" onclick="window.open('/project/${escapeAttr(p.id)}','_blank')" style="font-size:12px">&#128279; Open</button>
        ${!isGitProject ? `<button class="btn btn-secondary" onclick="showPushToGitLabModal('${escapeAttr(p.id)}', '${escapeAttr(p.name)}')" style="font-size:11px;color:var(--green)">&#128268; Push to GitLab</button>` : ''}
        <button class="btn btn-secondary" onclick="editProject('${escapeAttr(p.id)}')">&#9998; Edit</button>
        <button class="btn btn-secondary" style="color:var(--red)" onclick="deleteProject('${escapeAttr(p.id)}', '${escapeAttr(p.name)}')">&#128465;</button>
      </div>
    </div>`;
  }).join('');

  // Society Agent start - Add both Create and Git buttons
  html += `<div class="project-add-card" onclick="showCreateProjectModal()">+ Create New Project</div>`;
  html += `<div class="project-add-card" onclick="showGitModal()" style="border-color:var(--accent);color:var(--accent)">&#128268; Load from Git</div>`;
  // Society Agent end
  grid.innerHTML = html;
}

function renderSidebarProjects() {
  const list = document.getElementById('projectList');
  if (projects.length === 0) {
    list.innerHTML = '<div style="padding:8px 16px;color:var(--muted);font-size:12px">No projects ‚Äî go to Projects tab</div>';
    return;
  }
  // Society Agent start - show folder as main identifier (matches disk folder name)
  list.innerHTML = projects.map(p => {
    const agentCount = (p.agents || []).length;
    const folderName = p.folder || p.id; // Folder name = directory on disk
    return `<div class="agent-card" onclick="window.open('/project/${escapeAttr(p.id)}','_blank')" style="cursor:pointer" title="${escapeHtml(p.name || folderName)}">
      <div class="name">${escapeHtml(folderName)}</div>
      <div class="role">${agentCount} agent${agentCount !== 1 ? 's' : ''}</div>
      <span class="status-badge ${p.status === 'active' ? 'working' : 'idle'}">${p.status || 'active'}</span>
    </div>`;
  }).join('');
  // Society Agent end
}

// Project CRUD

// Society Agent start - simplified project creation
function slugify(text) {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').substring(0, 50);
}

function showCreateProjectModal() {
  editingProjectId = null;
  document.getElementById('projectModalTitle').textContent = 'Create Project';
  document.getElementById('projectModalDesc').textContent = 'Create a project to organize agents around a shared folder.';
  document.getElementById('projectFormName').value = '';
  document.getElementById('projectFormName').disabled = false;
  document.getElementById('projectFormDesc').value = '';
  document.getElementById('projectFormSubmit').textContent = 'Create';
  document.getElementById('projectFolderPreview').textContent = 'projects/';
  document.getElementById('projectModal').style.display = 'flex';
  
  // Update folder preview as user types
  document.getElementById('projectFormName').oninput = function() {
    const slug = slugify(this.value);
    document.getElementById('projectFolderPreview').textContent = slug ? 'projects/' + slug + '/' : 'projects/';
  };
}
// Society Agent end

// Society Agent start - simplified edit modal
function editProject(id) {
  const project = projects.find(p => p.id === id);
  if (!project) return;
  editingProjectId = id;
  document.getElementById('projectModalTitle').textContent = `Edit: ${project.name}`;
  document.getElementById('projectModalDesc').textContent = 'Update project settings. Agents are managed from the project page.';
  document.getElementById('projectFormName').value = project.name;
  document.getElementById('projectFormName').disabled = true; // Can't rename existing project
  document.getElementById('projectFormDesc').value = project.description || '';
  document.getElementById('projectFormSubmit').textContent = 'Save';
  document.getElementById('projectFolderPreview').textContent = 'projects/' + (project.folder || project.id) + '/';
  document.getElementById('projectModal').style.display = 'flex';
}
// Society Agent end

function hideProjectModal() {
  document.getElementById('projectModal').style.display = 'none';
  editingProjectId = null;
}

// Society Agent start - simplified: name is the id/folder
async function submitProjectForm() {
  const name = document.getElementById('projectFormName').value.trim();
  const id = slugify(name); // Auto-generate ID from name
  const description = document.getElementById('projectFormDesc').value.trim();
  const folder = id; // Folder is same as ID

  if (!name) {
    alert('Please enter a project name');
    return;
  }
// Society Agent end

  try {
    let res;
    if (editingProjectId) {
      res = await fetch(`${API}/api/projects/${editingProjectId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, folder }),
      });
    } else {
      res = await fetch(`${API}/api/projects`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, name, description, folder }),
      });
    }
    const data = await res.json();
    if (!res.ok) {
      alert(data.error || 'Failed');
      return;
    }
    hideProjectModal();
    addLog('info', editingProjectId ? `Project ${name} updated` : `Project ${name} created`);
    loadProjects();
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

async function deleteProject(id, name) {
  if (!confirm(`Delete project "${name}" and all its agents? This cannot be undone.`)) return;
  try {
    const res = await fetch(`${API}/api/projects/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if (data.success) {
      addLog('info', `Project ${name} deleted`);
      if (allProjectAgents.some(a => a.projectId === id && a.id === selectedAgentId)) {
        selectedAgentId = '';
      }
      loadProjects();
    } else {
      addLog('error', `Delete failed: ${data.error}`);
    }
  } catch (e) {
    addLog('error', `Delete error: ${e.message}`);
  }
}

// ===========================================================================
// Society Agent start - Git Integration Functions
// ===========================================================================

let gitCredentials = [];

// Git modal helpers
function updateGitFolderPreview() {
  const name = document.getElementById('gitFormName').value;
  const slug = slugify(name);
  document.getElementById('gitFolderPreview').textContent = slug ? 'projects/' + slug + '/' : 'projects/';
}

function showGitModal() {
  // Reset form
  document.getElementById('gitFormName').value = '';
  document.getElementById('gitFormUrl').value = '';
  document.getElementById('gitFormRef').value = 'main';
  document.getElementById('gitFormDesc').value = '';
  document.getElementById('gitFormStatus').style.display = 'none';
  document.getElementById('gitFormSubmit').disabled = false;
  document.getElementById('gitFormSubmit').textContent = 'üîó Clone & Create';
  document.getElementById('gitFolderPreview').textContent = 'projects/';
  
  // Load credentials for dropdown
  loadCredentials();
  
  document.getElementById('gitModal').style.display = 'flex';
}

function hideGitModal() {
  document.getElementById('gitModal').style.display = 'none';
}

async function submitGitForm() {
  const name = document.getElementById('gitFormName').value.trim();
  const id = slugify(name);
  const repoUrl = document.getElementById('gitFormUrl').value.trim();
  const ref = document.getElementById('gitFormRef').value.trim() || 'main';
  const credentialId = document.getElementById('gitFormCredential').value || undefined;
  const description = document.getElementById('gitFormDesc').value.trim();
  
  if (!name || !repoUrl) {
    showGitStatus('error', 'Project name and repository URL are required');
    return;
  }
  
  // Show loading state
  const submitBtn = document.getElementById('gitFormSubmit');
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ Cloning...';
  showGitStatus('info', 'Cloning repository... This may take a moment.');
  
  try {
    const res = await fetch(`${API}/api/projects/from-git`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, name, description, repoUrl, ref, credentialId }),
    });
    const data = await res.json();
    
    if (data.success) {
      showGitStatus('success', `‚úì ${data.message}`);
      addLog('info', `Project "${name}" loaded from Git`);
      loadProjects();
      setTimeout(() => hideGitModal(), 1500);
    } else {
      showGitStatus('error', `‚úó ${data.error || 'Clone failed'}`);
      submitBtn.disabled = false;
      submitBtn.textContent = 'üîó Clone & Create';
    }
  } catch (e) {
    showGitStatus('error', `‚úó Error: ${e.message}`);
    submitBtn.disabled = false;
    submitBtn.textContent = 'üîó Clone & Create';
  }
}

function showGitStatus(type, message) {
  const el = document.getElementById('gitFormStatus');
  el.style.display = 'block';
  el.style.background = type === 'error' ? 'rgba(248,81,73,0.15)' : 
                        type === 'success' ? 'rgba(63,185,80,0.15)' : 'rgba(88,166,255,0.15)';
  el.style.color = type === 'error' ? 'var(--red)' : 
                   type === 'success' ? 'var(--green)' : 'var(--accent)';
  el.textContent = message;
}

// Credentials management
async function loadCredentials() {
  try {
    const res = await fetch(`${API}/api/credentials`);
    const data = await res.json();
    gitCredentials = data.credentials || [];
    
    // Update dropdown in git modal
    const select = document.getElementById('gitFormCredential');
    select.innerHTML = '<option value="">None (public repo)</option>' +
      gitCredentials.map(c => `<option value="${escapeAttr(c.id)}">${escapeHtml(c.name)} (${c.type} @ ${c.host})</option>`).join('');
    
    // Update credentials list in credentials modal
    renderCredentialsList();
  } catch (e) {
    console.error('Failed to load credentials:', e);
  }
}

function renderCredentialsList() {
  const el = document.getElementById('credentialsList');
  if (gitCredentials.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:8px">No credentials stored</div>';
    return;
  }
  
  el.innerHTML = gitCredentials.map(c => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px;border-bottom:1px solid var(--border)">
      <span style="font-size:16px">${c.type === 'ssh-key' ? 'üîë' : 'üéüÔ∏è'}</span>
      <div style="flex:1">
        <div style="font-size:13px">${escapeHtml(c.name)}</div>
        <div style="font-size:11px;color:var(--muted)">${c.type} ‚Ä¢ ${c.host} ‚Ä¢ Added ${new Date(c.createdAt).toLocaleDateString()}</div>
      </div>
      <button onclick="deleteCredential('${escapeAttr(c.id)}')" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px">üóë</button>
    </div>
  `).join('');
}

function showCredentialsModal() {
  loadCredentials();
  document.getElementById('credFormName').value = '';
  document.getElementById('credFormType').value = 'ssh-key';
  document.getElementById('credFormHost').value = '';
  document.getElementById('credFormSecret').value = '';
  updateCredFormPlaceholder();
  document.getElementById('credentialsModal').style.display = 'flex';
}

function hideCredentialsModal() {
  document.getElementById('credentialsModal').style.display = 'none';
}

function updateCredFormPlaceholder() {
  const type = document.getElementById('credFormType').value;
  const label = document.getElementById('credFormSecretLabel');
  const textarea = document.getElementById('credFormSecret');
  
  if (type === 'ssh-key') {
    label.textContent = 'Private Key';
    textarea.placeholder = '-----BEGIN OPENSSH PRIVATE KEY-----\n...';
    textarea.rows = 4;
  } else {
    label.textContent = 'Access Token';
    textarea.placeholder = 'glpat-xxxxxxxxxxxxxxxxxxxx';
    textarea.rows = 1;
  }
}

async function addCredential() {
  const name = document.getElementById('credFormName').value.trim();
  const type = document.getElementById('credFormType').value;
  const host = document.getElementById('credFormHost').value.trim();
  const secret = document.getElementById('credFormSecret').value.trim();
  
  if (!name || !host || !secret) {
    alert('Please fill in all fields');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/credentials`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, type, host, secret }),
    });
    
    if (res.ok) {
      addLog('info', `Credential "${name}" added`);
      loadCredentials();
      // Clear form
      document.getElementById('credFormName').value = '';
      document.getElementById('credFormSecret').value = '';
    } else {
      const data = await res.json();
      alert(`Error: ${data.error}`);
    }
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

async function deleteCredential(id) {
  if (!confirm('Delete this credential?')) return;
  
  try {
    const res = await fetch(`${API}/api/credentials/${id}`, { method: 'DELETE' });
    if (res.ok) {
      addLog('info', 'Credential deleted');
      loadCredentials();
    }
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

// Git actions for existing projects
async function showGitActions(projectId) {
  const project = projects.find(p => p.id === projectId);
  if (!project || !project.gitConfig) return;
  
  document.getElementById('gitActionsTitle').textContent = `üîó Git: ${project.name}`;
  document.getElementById('gitActionsContent').innerHTML = '<div style="color:var(--muted)">Loading...</div>';
  document.getElementById('gitActionsModal').style.display = 'flex';
  
  try {
    // Get status and branches
    const [statusRes, branchesRes] = await Promise.all([
      fetch(`${API}/api/projects/${projectId}/git/status`),
      fetch(`${API}/api/projects/${projectId}/git/branches`),
    ]);
    
    const status = await statusRes.json();
    const branches = await branchesRes.json();
    
    const hasChanges = status.hasLocalChanges;
    const changedFiles = status.changedFiles || [];
    
    let html = `
      <div style="margin-bottom:16px">
        <div style="font-size:13px;margin-bottom:8px"><strong>Repository:</strong> ${escapeHtml(project.gitConfig.url)}</div>
        <div style="font-size:13px;margin-bottom:8px"><strong>Current Branch:</strong> üåø ${escapeHtml(status.currentRef || 'unknown')}</div>
        ${status.ahead || status.behind ? `<div style="font-size:12px;color:var(--muted)">‚Üë ${status.ahead || 0} ahead, ‚Üì ${status.behind || 0} behind</div>` : ''}
      </div>
      
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Local Changes</div>
        ${hasChanges ? `
          <div style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px;font-family:monospace;font-size:11px;max-height:120px;overflow-y:auto">
            ${changedFiles.map(f => `<div>${escapeHtml(f)}</div>`).join('')}
          </div>
        ` : '<div style="color:var(--green);font-size:12px">‚úì No local changes</div>'}
      </div>
      
      <div style="margin-bottom:16px">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Switch Branch</div>
        <select id="gitBranchSelect" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--text);font-size:12px">
          ${branches.local?.map(b => `<option value="${escapeAttr(b)}" ${b === status.currentRef ? 'selected' : ''}>${escapeHtml(b)}</option>`).join('')}
          <optgroup label="Remote">
            ${branches.remote?.filter(b => !branches.local?.includes(b)).map(b => `<option value="${escapeAttr(b)}">${escapeHtml(b)}</option>`).join('')}
          </optgroup>
        </select>
        <button onclick="checkoutBranch('${escapeAttr(projectId)}')" class="btn btn-secondary" style="margin-top:8px;font-size:11px">Checkout</button>
      </div>
      
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button onclick="pullProject('${escapeAttr(projectId)}')" class="btn btn-secondary" style="font-size:11px">‚¨áÔ∏è Pull</button>
        ${hasChanges ? `
          <button onclick="showPushForm('${escapeAttr(projectId)}')" class="btn btn-primary" style="font-size:11px">‚¨ÜÔ∏è Push Changes</button>
          <button onclick="viewDiff('${escapeAttr(projectId)}')" class="btn btn-secondary" style="font-size:11px">üìÑ View Diff</button>
        ` : ''}
      </div>
      
      <div id="gitPushForm" style="display:none;margin-top:16px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:4px">
        <div class="form-group">
          <label>New Branch Name</label>
          <input type="text" id="gitPushBranch" placeholder="feature/my-changes" style="width:100%">
        </div>
        <div class="form-group">
          <label>Commit Message</label>
          <input type="text" id="gitPushMessage" placeholder="Agent changes: ..." style="width:100%">
        </div>
        <button onclick="pushChanges('${escapeAttr(projectId)}')" class="btn btn-primary" style="font-size:12px">Create Branch & Push</button>
      </div>
    `;
    
    document.getElementById('gitActionsContent').innerHTML = html;
  } catch (e) {
    document.getElementById('gitActionsContent').innerHTML = `<div style="color:var(--red)">Error: ${e.message}</div>`;
  }
}

function hideGitActionsModal() {
  document.getElementById('gitActionsModal').style.display = 'none';
}

function showPushForm(projectId) {
  document.getElementById('gitPushForm').style.display = 'block';
}

async function pullProject(projectId) {
  try {
    const res = await fetch(`${API}/api/projects/${projectId}/git/pull`, { method: 'POST' });
    const data = await res.json();
    
    if (data.success) {
      addLog('info', `Pulled latest changes for project`);
      showGitActions(projectId); // Refresh modal
    } else {
      alert(`Pull failed: ${data.message}`);
    }
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

async function checkoutBranch(projectId) {
  const ref = document.getElementById('gitBranchSelect').value;
  if (!ref) return;
  
  try {
    const res = await fetch(`${API}/api/projects/${projectId}/git/checkout`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ref }),
    });
    const data = await res.json();
    
    if (data.success) {
      addLog('info', `Checked out ${ref}`);
      loadProjects();
      showGitActions(projectId);
    } else {
      alert(`Checkout failed: ${data.message}`);
    }
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

async function pushChanges(projectId) {
  const branchName = document.getElementById('gitPushBranch').value.trim();
  const commitMessage = document.getElementById('gitPushMessage').value.trim();
  
  if (!branchName || !commitMessage) {
    alert('Branch name and commit message are required');
    return;
  }
  
  try {
    const res = await fetch(`${API}/api/projects/${projectId}/git/push`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ branchName, commitMessage }),
    });
    const data = await res.json();
    
    if (data.success) {
      addLog('info', `Pushed changes to ${branchName}`);
      loadProjects();
      showGitActions(projectId);
    } else {
      alert(`Push failed: ${data.message}`);
    }
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

async function viewDiff(projectId) {
  try {
    const res = await fetch(`${API}/api/projects/${projectId}/git/diff`);
    const data = await res.json();
    
    if (data.diff) {
      // Show in a simple alert for now (could be a modal with syntax highlighting)
      const diffWindow = window.open('', '_blank', 'width=800,height=600');
      diffWindow.document.write(`<html><head><title>Git Diff</title><style>body{background:#0d1117;color:#e6edf3;font-family:monospace;padding:20px;white-space:pre-wrap;}</style></head><body>${escapeHtml(data.diff)}</body></html>`);
    } else {
      alert('No changes to show');
    }
  } catch (e) {
    alert(`Error: ${e.message}`);
  }
}

// Push local project to GitLab
function showPushToGitLabModal(projectId, projectName) {
  document.getElementById('pushGitLabProjectId').value = projectId;
  document.getElementById('pushGitLabRepoName').value = projectName.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
  document.getElementById('pushGitLabError').style.display = 'none';
  document.getElementById('pushGitLabSuccess').style.display = 'none';
  document.getElementById('pushGitLabBtn').disabled = false;
  document.getElementById('pushGitLabBtn').textContent = 'üîó Create & Push';
  document.getElementById('pushGitLabNamespace').innerHTML = '<option value="">Select credential first...</option>';
  
  // Load credentials (GitLab tokens only)
  loadPushGitLabCredentials();
  
  document.getElementById('pushToGitLabModal').style.display = 'flex';
}

function hidePushToGitLabModal() {
  document.getElementById('pushToGitLabModal').style.display = 'none';
}

async function loadPushGitLabCredentials() {
  try {
    const res = await fetch(`${API}/api/credentials`);
    const data = await res.json();
    const tokenCreds = (data.credentials || []).filter(c => c.type === 'token');
    
    const select = document.getElementById('pushGitLabCredential');
    if (tokenCreds.length === 0) {
      select.innerHTML = '<option value="">No GitLab tokens - add one in Credentials</option>';
    } else if (tokenCreds.length === 1) {
      // Auto-select and load namespaces when only one credential
      select.innerHTML = `<option value="${escapeAttr(tokenCreds[0].id)}">${escapeHtml(tokenCreds[0].name)} (${tokenCreds[0].host})</option>`;
      loadPushGitLabNamespaces(tokenCreds[0].id);
    } else {
      select.innerHTML = '<option value="">Select a credential...</option>' +
        tokenCreds.map(c => `<option value="${escapeAttr(c.id)}">${escapeHtml(c.name)} (${c.host})</option>`).join('');
    }
    
    // Add change listener to load namespaces
    select.onchange = () => loadPushGitLabNamespaces(select.value);
  } catch (e) {
    console.error('Failed to load credentials:', e);
  }
}

async function loadPushGitLabNamespaces(credentialId) {
  const nsSelect = document.getElementById('pushGitLabNamespace');
  if (!credentialId) {
    nsSelect.innerHTML = '<option value="">Select credential first...</option>';
    return;
  }
  
  nsSelect.innerHTML = '<option value="">Loading...</option>';
  
  try {
    const res = await fetch(`${API}/api/credentials/${credentialId}/namespaces`);
    const data = await res.json();
    
    if (data.namespaces && data.namespaces.length > 0) {
      nsSelect.innerHTML = '<option value="">(Personal namespace)</option>' +
        data.namespaces.map(ns => `<option value="${escapeAttr(ns.id)}">${escapeHtml(ns.full_path)} (${ns.kind})</option>`).join('');
    } else {
      nsSelect.innerHTML = '<option value="">(Personal namespace)</option>';
    }
  } catch (e) {
    nsSelect.innerHTML = '<option value="">(Personal namespace - could not load groups)</option>';
  }
}

async function pushToGitLab() {
  const projectId = document.getElementById('pushGitLabProjectId').value;
  const credentialId = document.getElementById('pushGitLabCredential').value;
  const repoName = document.getElementById('pushGitLabRepoName').value.trim();
  const namespaceId = document.getElementById('pushGitLabNamespace').value || undefined;
  const visibility = document.getElementById('pushGitLabVisibility').value;
  
  const errorEl = document.getElementById('pushGitLabError');
  const successEl = document.getElementById('pushGitLabSuccess');
  const btn = document.getElementById('pushGitLabBtn');
  
  errorEl.style.display = 'none';
  successEl.style.display = 'none';
  
  if (!credentialId) {
    errorEl.textContent = 'Please select a GitLab credential';
    errorEl.style.display = 'block';
    return;
  }
  
  if (!repoName) {
    errorEl.textContent = 'Please enter a repository name';
    errorEl.style.display = 'block';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = '‚è≥ Creating repository...';
  
  try {
    const res = await fetch(`${API}/api/projects/${projectId}/git/push-to-gitlab`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ credentialId, repoName, namespaceId, visibility }),
    });
    const data = await res.json();
    
    if (data.success) {
      successEl.innerHTML = `‚úì Repository created and pushed!<br><a href="${escapeHtml(data.repoUrl)}" target="_blank" style="color:white">${escapeHtml(data.repoUrl)}</a>`;
      successEl.style.display = 'block';
      btn.textContent = '‚úì Done!';
      addLog('info', `Pushed project "${projectId}" to GitLab`);
      loadProjects();
      setTimeout(() => hidePushToGitLabModal(), 3000);
    } else {
      errorEl.textContent = data.error || 'Failed to push to GitLab';
      errorEl.style.display = 'block';
      btn.disabled = false;
      btn.textContent = 'üîó Create & Push';
    }
  } catch (e) {
    errorEl.textContent = `Error: ${e.message}`;
    errorEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'üîó Create & Push';
  }
}

// Society Agent end - Git Integration Functions
// ===========================================================================

// Load projects on startup
socket.on('connect', () => { 
  loadProjects(); 
  refreshSkills();
  refreshMcps();
});
// Refresh on agent events
socket.on('system-event', (data) => {
  if (data.type === 'agent-created' || data.type === 'agent-deleted') loadProjects();
});

// ============================================================================
// Tab Switching
// ============================================================================

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
  if (tab === 'terminal') {
    document.getElementById('tabTerminal').classList.add('active');
    document.getElementById('paneTerminal').classList.add('active');
    if (!term) initTerminal();
    else fitAddon.fit();
  } else if (tab === 'projects') {
    document.getElementById('tabProjects').classList.add('active');
    document.getElementById('paneProjects').classList.add('active');
    loadProjects(); // refresh when switching to tab
  } else {
    document.getElementById('tabChat').classList.add('active');
    document.getElementById('paneChat').classList.add('active');
  }
}

// ============================================================================
// Terminal (xterm.js + node-pty via WebSocket)
// ============================================================================

let term = null;
let fitAddon = null;
let termConnected = false;

function initTerminal() {
  const container = document.getElementById('terminalContainer');
  container.innerHTML = '';

  term = new Terminal({
    cursorBlink: true,
    fontSize: 14,
    fontFamily: "'SF Mono', 'Cascadia Code', 'Consolas', monospace",
    theme: {
      background: '#0d1117',
      foreground: '#e6edf3',
      cursor: '#58a6ff',
      selectionBackground: 'rgba(88,166,255,0.3)',
      black: '#484f58', red: '#f85149', green: '#3fb950', yellow: '#d29922',
      blue: '#58a6ff', magenta: '#bc8cff', cyan: '#39c5cf', white: '#b1bac4',
    },
  });

  fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.open(container);

  // Small delay for the container to be laid out before fitting
  setTimeout(() => fitAddon.fit(), 100);

  window.addEventListener('resize', () => { if (fitAddon) fitAddon.fit(); });

  connectTerminal();

  term.onData((data) => {
    if (termConnected) {
      socket.emit('terminal-input', data);
    }
  });

  term.onResize(({ cols, rows }) => {
    if (termConnected) {
      socket.emit('terminal-resize', { cols, rows });
    }
  });
}

function connectTerminal() {
  const shell = document.getElementById('termShell').value;
  socket.emit('terminal-start', { shell, cols: term.cols, rows: term.rows });
  term.clear();
  term.writeln('\x1b[33mConnecting to terminal...\x1b[0m');
}

function reconnectTerminal() {
  socket.emit('terminal-stop');
  setTimeout(() => connectTerminal(), 200);
}

socket.on('terminal-output', (data) => {
  if (term) term.write(data);
  termConnected = true;
});

socket.on('terminal-ready', () => {
  termConnected = true;
  if (term) {
    term.clear();
    addLog('info', 'Terminal connected');
  }
});

socket.on('terminal-exit', (data) => {
  termConnected = false;
  if (term) term.writeln(`\x1b[31m\r\nProcess exited (code ${data.code})\x1b[0m`);
  addLog('warn', `Terminal exited (code ${data.code})`);
});
</script>
</body>
</html>
